<!DOCTYPE html>
<html>
<head>
    <title>Resume Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
    <script src="/static/js/auth.js"></script>
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .sidebar { background: #fff; border-right: 1px solid #f3f4f6; min-height: 100vh; }
        .sidebar .active, .sidebar a:hover { color: #059669; background: #f0fdf4; }
        .emerald { color: #059669; }
        .emerald-bg { background: #059669; }
        .brand-syn { color: #059669; }
        .brand-texa { color: #111827; }
        .card { background: #fff; border-radius: 1.25rem; box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.08); transition: box-shadow 0.3s; }
        .card:hover { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12); }
        .ats-bar { background: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; }
        .ats-bar-inner { background: #059669; height: 100%; border-radius: 9999px; transition: width 1s cubic-bezier(0.4,0,0.2,1); }
        .sidebar-icon { color: #6b7280; margin-right: 0.75rem; }
        .sidebar .active .sidebar-icon, .sidebar a:hover .sidebar-icon { color: #059669; }
        .improvement-tip { border-radius: 0.75rem; padding: 1rem 1.25rem; margin-bottom: 0.75rem; display: flex; align-items: center; font-weight: 500; }
        .tip-high { background: #fef2f2; color: #b91c1c; }
        .tip-medium { background: #fef9c3; color: #b45309; }
        .tip-low { background: #f0fdf4; color: #059669; }
        .tab-btn { background: #f3f4f6; color: #374151; border-radius: 0.5rem; padding: 0.5rem 1.25rem; font-weight: 600; margin-right: 0.5rem; transition: background 0.2s, color 0.2s; }
        .tab-btn.active, .tab-btn:hover { background: #059669; color: #fff; }
        .analytics-salary { background: #f9fafb; border-radius: 0.75rem; padding: 1rem 1.25rem; margin-bottom: 1rem; }
        .job-match-row { display: flex; align-items: center; justify-content: space-between; border-radius: 0.5rem; padding: 0.75rem 1rem; margin-bottom: 0.5rem; font-weight: 500; }
        .job-match-row.job1 { background: #f0fdf4; color: #059669; }
        .job-match-row.job2 { background: #f3f4f6; color: #374151; }
        .job-match-row.job3 { background: #f9fafb; color: #6b7280; }
        .quick-action-btn { background: #f9fafb; color: #374151; border: 1px solid #e5e7eb; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s; text-decoration: none; }
        .quick-action-btn:hover { background: #f0fdf4; border-color: #059669; color: #059669; transform: translateY(-1px); }
        .quick-action-btn.active { background: #059669; color: #fff; border-color: #059669; }
        .profile-dropdown { position: relative; }
        .header-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; text-decoration: none; }
        .header-btn.improve { background: #f0fdf4; color: #059669; border: 1px solid #059669; }
        .header-btn.improve:hover { background: #059669; color: #fff; }
        .header-btn.ats { background: #1f2937; color: #fff; border: 1px solid #1f2937; }
        .header-btn.ats:hover { background: #374151; }
        /* Profile specific styles */
        .profile-avatar-hover:hover { transform: scale(1.05); transition: transform 0.2s ease; }
        .profile-menu-enter { animation: slideDown 0.2s ease-out; }
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Upgraded metric bar styles */
        .metric { margin-bottom: 0.75rem; }
        .metric-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:0.25rem; }
        .metric-pill { font-size: 0.75rem; font-weight:700; padding:0.125rem 0.5rem; border-radius:9999px; color:#111827; background:#f3f4f6; }
        .metric-track { height: 12px; border-radius: 9999px; background:#f3f4f6; overflow:hidden; }
        .metric-fill { height:100%; width:0; border-radius:9999px; transition: width 900ms cubic-bezier(0.4,0,0.2,1); }
        .fill-format { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .fill-keywords { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .fill-skills { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        .fill-experience { background: linear-gradient(90deg, #10b981 0%, #059669 100%); }
        /* Company roast widget styles */
        .company-roast-btn { 
            display: flex; 
            align-items: center; 
            padding: 0.75rem; 
            border: 2px solid #e5e7eb; 
            border-radius: 0.75rem; 
            background: white; 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            font-size: 0.875rem; 
            font-weight: 600; 
            color: #374151;
            position: relative;
            overflow: hidden;
        }
        .company-roast-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(5, 150, 105, 0.1), transparent);
            transition: left 0.5s;
        }
        .company-roast-btn:hover::before {
            left: 100%;
        }
        .company-roast-btn:hover { 
            border-color: #059669; 
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%); 
            transform: translateY(-2px) scale(1.02); 
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.15);
        }
        .company-roast-btn.selected { 
            border-color: #059669; 
            background: linear-gradient(135deg, #059669 0%, #047857 100%); 
            color: #fff; 
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }
        .company-roast-btn img { 
            filter: grayscale(100%); 
            transition: filter 0.3s; 
        }
        .company-roast-btn:hover img, .company-roast-btn.selected img { 
            filter: grayscale(0%); 
        }
        #companyRoastWidget { 
            display: none; 
        }
        #companyRoastWidget.show { 
            display: block; 
        }
        #floatingRoastBtn { 
            display: block;
            position: fixed !important;
            bottom: 1.5rem !important;
            right: 1.5rem !important;
            z-index: 40 !important;
        }
        #floatingRoastBtn.hidden { 
            display: none; 
        }
        
        /* Cool floating button styles */
        .floating-roast-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 25%, #ff9500 50%, #ffcc02 75%, #32d74b 100%);
            background-size: 300% 300%;
            animation: gradientShift 3s ease infinite;
            position: relative;
            overflow: hidden;
        }
        
        .floating-roast-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: rotate 2s linear infinite;
        }
        
        .floating-roast-btn::after {
            content: '';
            position: absolute;
            inset: 2px;
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            border-radius: 50%;
            z-index: 1;
        }
        
        .floating-roast-btn i {
            position: relative;
            z-index: 2;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Cool modal animations */
        .modal-enter {
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        
        .modal-exit {
            animation: modalSlideOut 0.3s ease-in-out;
        }
        
        @keyframes modalSlideIn {
            0% {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes modalSlideOut {
            0% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            100% {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
        }
        
        .backdrop-enter {
            animation: backdropFadeIn 0.3s ease-out;
        }
        
        .backdrop-exit {
            animation: backdropFadeOut 0.2s ease-in;
        }
        
        @keyframes backdropFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        @keyframes backdropFadeOut {
            0% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body class="bg-gray-50">
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="sidebar w-64 flex flex-col justify-between py-8 px-6">
        <div>
            <div class="flex items-center mb-10">
                <span class="text-2xl font-extrabold tracking-tight"><span class="brand-syn">Syn</span><span class="brand-texa">texa</span></span>
            </div>
            <nav class="flex flex-col gap-2">
                <a href="/dashboard/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-4 py-2 active">
                    <i class="fas fa-th-large sidebar-icon"></i>Dashboard
                </a>
                <a href="/generate-ats-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-4 py-2">
                    <i class="fas fa-file-alt sidebar-icon"></i>ATS Resume
                </a>
                <a href="/upload" class="flex items-center px-4 py-2">
                    <i class="fas fa-upload sidebar-icon"></i>Upload Resume
                </a>
                <a href="/improve-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-4 py-2">
                    <i class="fas fa-edit sidebar-icon"></i>Improve Resume
                </a>
                <a href="/cover-letter/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-4 py-2">
                    <i class="fas fa-envelope sidebar-icon"></i>Cover Letter
                </a>
                <a href="/email/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-4 py-2">
                    <i class="fas fa-paper-plane sidebar-icon"></i>Cold Email
                </a>
                <a href="/analyze-job/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-4 py-2">
                    <i class="fas fa-search sidebar-icon"></i>Analyze Job Description
                </a>
                <a href="/profile-analysis" class="flex items-center px-4 py-2">
                    <i class="fas fa-microscope sidebar-icon"></i>Analyze LinkedIn/GitHub <span class="ml-1 text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full align-middle">BETA</span>
                </a>
            </nav>
            <div class="mt-10">
                <div class="text-xs text-gray-400 font-semibold mb-2">SUPPORT</div>
                <a href="/help" class="flex items-center px-4 py-2">
                    <i class="fas fa-question-circle sidebar-icon"></i>Help & Resources
                </a>
                <a href="/settings" class="flex items-center px-4 py-2">
                    <i class="fas fa-cog sidebar-icon"></i>Settings
                </a>
            </div>
        </div>
        <div class="flex items-center gap-3 bg-gray-100 rounded-lg p-3 mt-8">
            <img id="sidebarAvatar" class="w-10 h-10 rounded-full bg-gray-200 border-2 border-emerald-200" alt="Profile" 
                 src="https://api.dicebear.com/8.x/personas/svg?seed={{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'default-user' }}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50" />
            <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-700 text-sm truncate">
                    <!-- {{ resume_data.parsed_data.personal_info.name if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.name else 'User' }} -->
                </div>
                <div class="text-xs text-gray-500 truncate">
                    <!-- {{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'user@example.com' }} -->
                </div>
                {% if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.phone %}
                <div class="text-xs text-gray-400 truncate">
                    <i class="fas fa-phone-alt mr-1"></i>{{ resume_data.parsed_data.personal_info.phone }}
                </div>
                {% endif %}
            </div>
        </div>
    </aside>
    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Top Bar -->
        <header class="flex items-center justify-between px-10 py-6 bg-white border-b border-gray-100">
            <h1 class="text-3xl font-extrabold tracking-tight">Dashboard <i class="fas fa-sparkles emerald ml-2"></i></h1>
            <div class="flex items-center gap-4">
                <a href="/improve-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="header-btn improve flex items-center">
                    </i>Improve Resume
                </a>
                <a href="/generate-ats-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="header-btn ats flex items-center">
                    </i>Generate ATS Resume
                </a>
                <div class="profile-dropdown">
                    <div id="profileAvatarBtn" class="w-10 h-10 rounded-full cursor-pointer border-2 border-emerald-200 hover:border-emerald-400 transition-colors overflow-hidden">
                        <img id="headerAvatar" class="w-full h-full object-cover" alt="Profile" 
                             src="https://api.dicebear.com/8.x/personas/svg?seed={{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'default-user' }}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50" />
                    </div>
                    <div id="profileMenu" class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-xl border border-gray-100 p-4 hidden z-50">
                        <div class="flex items-center gap-3 mb-4">
                            <img id="profileAvatar" class="w-16 h-16 rounded-full border-2 border-emerald-200" alt="Profile Avatar" 
                                 src="https://api.dicebear.com/8.x/personas/svg?seed={{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'default-user' }}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50" />
                            <div class="flex-1 min-w-0">
                                <div id="profileName" class="font-bold text-lg text-gray-900 truncate">
                                    <!-- {{ resume_data.parsed_data.personal_info.name if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.name else 'User' }} -->
                                </div>
                                <div id="profileEmail" class="text-sm text-gray-600 truncate">
                                    <!-- {{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'user@example.com' }} -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="border-t border-gray-100 pt-3 space-y-2">
                            {% if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info %}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-user mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Name</div>
                                    <div class="font-medium">{{ resume_data.parsed_data.personal_info.name }}</div>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-envelope mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Email</div>
                                    <div class="font-medium">{{ resume_data.parsed_data.personal_info.email }}</div>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-phone mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Phone</div>
                                    <div class="font-medium">{{ resume_data.parsed_data.personal_info.phone if resume_data.parsed_data.personal_info.phone else 'Not provided' }}</div>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-map-marker-alt mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Location</div>
                                    <div class="font-medium">{{ resume_data.parsed_data.personal_info.location if resume_data.parsed_data.personal_info.location else 'Not specified' }}</div>
                                </div>
                            </div>
                            {% if resume_data.parsed_data.personal_info.linkedin %}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fab fa-linkedin mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">LinkedIn</div>
                                    <a href="{{ resume_data.parsed_data.personal_info.linkedin }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">
                                        LinkedIn Profile
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            {% if resume_data.parsed_data.personal_info.github %}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fab fa-github mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">GitHub</div>
                                    <a href="{{ resume_data.parsed_data.personal_info.github }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">
                                        GitHub Profile
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            {% if resume_data.parsed_data.personal_info.website %}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-globe mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Website</div>
                                    <a href="{{ resume_data.parsed_data.personal_info.website }}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:underline font-medium">
                                        Portfolio Website
                                    </a>
                                </div>
                            </div>
                            {% endif %}
                            {% else %}
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-user mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Name</div>
                                    <div class="font-medium">User</div>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-envelope mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Email</div>
                                    <div class="font-medium">user@example.com</div>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-phone mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Phone</div>
                                    <div class="font-medium">Not provided</div>
                                </div>
                            </div>
                            <div class="flex items-center text-sm text-gray-700">
                                <i class="fas fa-map-marker-alt mr-3 text-emerald-600 w-4"></i>
                                <div>
                                    <div class="text-xs text-gray-500">Location</div>
                                    <div class="font-medium">Not specified</div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        <div class="border-t border-gray-100 mt-3 pt-3">
                            <div class="flex items-center justify-between mb-3">
                                <a href="/settings" class="text-sm text-emerald-600 hover:text-emerald-700 font-medium flex items-center">
                                    <i class="fas fa-cog mr-2"></i>Account Settings
                                </a>
                                <a href="/help" class="text-sm text-gray-500 hover:text-gray-700 flex items-center">
                                    <i class="fas fa-question-circle mr-1"></i>Help
                                </a>
                            </div>
                            <button onclick="handleLogout()" class="w-full bg-red-50 hover:bg-red-100 text-red-600 hover:text-red-700 px-3 py-2 rounded-lg text-sm font-medium flex items-center justify-center transition-colors">
                                <i class="fas fa-sign-out-alt mr-2"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Dashboard Cards -->
        <main class="flex-1 p-10 bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Resume Overview (Main Card) -->
                <div class="md:col-span-2 card p-8">
                    <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                        <div class="text-2xl font-bold">Resume Overview</div>
                        <div class="text-sm text-gray-200">AI-powered analysis of your current resume</div>
                    </div>
                    <div class="mb-6">
                        <button class="tab-btn active" data-tab="summary">Summary</button>
                        <button class="tab-btn" data-tab="skills">Skills</button>
                        <button class="tab-btn" data-tab="experience">Experience</button>
                    </div>
                    <!-- Summary Tab -->
                    <div id="overviewSummary">
                        <div class="font-bold mb-2">ATS Score Breakdown</div>
                        <div id="atsBreakdown" class="mb-6">
                            <div class="metric">
                                <div class="metric-header"><span>Format</span><span id="atsFormatVal" class="metric-pill">--%</span></div>
                                <div class="metric-track"><div id="atsFormatBar" class="metric-fill fill-format"></div></div>
                            </div>
                            <div class="metric">
                                <div class="metric-header"><span>Keywords</span><span id="atsKeywordsVal" class="metric-pill">--%</span></div>
                                <div class="metric-track"><div id="atsKeywordsBar" class="metric-fill fill-keywords"></div></div>
                            </div>
                            <div class="metric">
                                <div class="metric-header"><span>Skills</span><span id="atsSkillsVal" class="metric-pill">--%</span></div>
                                <div class="metric-track"><div id="atsSkillsBar" class="metric-fill fill-skills"></div></div>
                            </div>
                            <div class="metric">
                                <div class="metric-header"><span>Experience</span><span id="atsExperienceVal" class="metric-pill">--%</span></div>
                                <div class="metric-track"><div id="atsExperienceBar" class="metric-fill fill-experience"></div></div>
                            </div>
                        </div>
                        <div>
                            <div class="font-bold mb-2">Key Improvements Needed</div>
                            <div id="quickSuggestionsOverview" class="space-y-2">
                                <div class="improvement-tip tip-high"><i class="fas fa-exclamation-triangle mr-2"></i> Loading suggestions...</div>
                            </div>
                        </div>
                    </div>
                    <!-- Skills Tab -->
                    <div id="overviewSkills" class="hidden">
                        <div class="font-bold mb-2">Skills</div>
                        <div id="skillsContainer" class="flex flex-wrap gap-2">
                            {% if resume_data and resume_data.parsed_data and resume_data.parsed_data.skills %}
                                {% for skill in resume_data.parsed_data.skills %}
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium">{{ skill }}</span>
                                {% endfor %}
                            {% else %}
                                <span class="text-gray-400">No skills listed</span>
                            {% endif %}
                        </div>
                    </div>
                    <!-- Experience Tab -->
                    <div id="overviewExperience" class="hidden">
                        <div class="font-bold mb-2">Experience</div>
                        <div id="experienceContainer" class="space-y-4">
                            {% if resume_data and resume_data.parsed_data and resume_data.parsed_data.experience %}
                                {% for exp in resume_data.parsed_data.experience %}
                                    <div class="border-l-4 border-emerald-500 pl-4 py-2">
                                        <div class="flex justify-between items-start mb-1">
                                            <div>
                                                <div class="font-semibold text-gray-900">{{ exp.title | safe }}</div>
                                                <div class="text-gray-600 text-sm">{{ exp.company | safe }}</div>
                                            </div>
                                            <span class="text-xs text-gray-500 whitespace-nowrap">{{ exp.duration | safe }}</span>
                                        </div>
                                        {% if exp.responsibilities %}
                                            <ul class="list-disc list-inside mt-1 space-y-1">
                                                {% for resp in exp.responsibilities %}
                                                    <li class="text-gray-700">{{ resp | safe }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                        {% if exp.achievements %}
                                            <div class="mt-2 text-sm">
                                                <span class="font-medium">Key Achievements:</span>
                                                <ul class="list-disc list-inside mt-1 space-y-1">
                                                    {% for achievement in exp.achievements %}
                                                        <li class="text-gray-700">{{ achievement | safe }}</li>
                                                    {% endfor %}
                                                </ul>
                                            </div>
                                        {% endif %}
                                        {% if exp.technologies %}
                                            <div class="mt-2 flex flex-wrap gap-2">
                                                {% for tech in exp.technologies %}
                                                    <span class="bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs">{{ tech | safe }}</span>
                                                {% endfor %}
                                            </div>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-gray-400">No experience data available</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Right Panel: Resume Analytics + Quick Actions -->
                <div class="flex flex-col gap-6">
                    <div class="card p-6">
                        <div class="font-bold text-2xl mb-4">Resume Analytics</div>
                        <div class="mb-2 font-semibold">ATS Score <span id="atsScoreValue" class="text-green-700 ml-2">--%</span></div>
                        <div class="ats-bar w-full mb-2">
                            <div id="atsScoreBar" class="ats-bar-inner" style="width: 0%;"></div>
                        </div>
                        <div class="text-xs text-gray-500 mb-4">Applicant Tracking System compatibility</div>
                        <div class="font-semibold mb-2">Best Job Matches</div>
                        <div id="jobRoleFit" class="space-y-2">
                            <div class="h-8 bg-gray-100 rounded animate-pulse"></div>
                            <div class="h-8 bg-gray-100 rounded animate-pulse"></div>
                            <div class="h-8 bg-gray-100 rounded animate-pulse"></div>
                        </div>
                        <div class="font-semibold mt-4 mb-2">Estimated Salary Range</div>
                        <div id="salaryRange" class="analytics-salary">
                            <div class="h-5 bg-gray-100 rounded w-40 mb-2 animate-pulse"></div>
                            <div class="h-4 bg-gray-100 rounded w-56 animate-pulse"></div>
                        </div>
                    </div>
                    <div class="card p-6">
                        <div class="font-bold text-xl mb-4">Quick Actions</div>
                        <div class="flex flex-col gap-3">
                            <a href="/upload" class="quick-action-btn active flex items-center gap-2 px-4 py-3"><i class="fas fa-upload"></i>Upload New Resume</a>
                            <a href="/analyze-job/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="quick-action-btn flex items-center gap-2 px-4 py-3"><i class="fas fa-search"></i>Analyze Job Description</a>
                            <a href="/cover-letter/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="quick-action-btn flex items-center gap-2 px-4 py-3"><i class="fas fa-envelope"></i>Generate Cover Letter</a>
                            <a href="/email/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="quick-action-btn flex items-center gap-2 px-4 py-3"><i class="fas fa-paper-plane"></i>Generate Cold Email</a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>

<!-- Company Roast Widget -->
<div id="companyRoastWidget" class="fixed bottom-6 right-6 w-80 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 transition-all duration-300 transform hover:scale-105">
    <div class="bg-gradient-to-r from-gray-900 to-black text-white p-4 rounded-t-2xl relative overflow-hidden">
        <div class="absolute inset-0 bg-gradient-to-r from-emerald-600/20 to-emerald-500/10"></div>
        <div class="relative flex items-center justify-between">
            <div class="flex items-center">
                <i class="fas fa-chart-line text-xl mr-2 text-emerald-400"></i>
                <span class="font-bold text-lg">Get Roasted</span>
            </div>
            <button id="closeRoastWidget" class="text-white hover:text-emerald-300 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <p class="text-sm text-gray-200 mt-1 relative">Get roasted by top companies</p>
    </div>
    
    <div class="p-4">
        <!-- LinkedIn URL Input -->
        <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
                <i class="fab fa-linkedin text-emerald-600 mr-2"></i>
                LinkedIn Profile URL
            </label>
            <input type="url" id="linkedinUrlInput" 
                   placeholder="https://linkedin.com/in/your-profile" 
                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 text-sm transition-all duration-200">
        </div>
        
        <!-- Company Buttons -->
        <div class="grid grid-cols-2 gap-3 mb-4">
            <button class="company-roast-btn" data-company="google">
                <img src="templates/goog.svg" alt="Meta" class="w-6 h-6 mr-2">
                <span>Google</span>
            </button>
            <button class="company-roast-btn" data-company="meta">
                <img src="https://upload.wikimedia.org/wikipedia/commons/8/89/Facebook_Logo_%282019%29.svg" alt="Meta" class="w-6 h-6 mr-2">
                <span>Meta</span>
            </button>
            <button class="company-roast-btn" data-company="amazon">
                <img src="https://upload.wikimedia.org/wikipedia/commons/a/a9/Amazon_logo.svg" alt="Amazon" class="w-6 h-6 mr-2">
                <span>Amazon</span>
            </button>
            <button class="company-roast-btn" data-company="microsoft">
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/44/Microsoft_logo.svg" alt="Microsoft" class="w-6 h-6 mr-2">
                <span>Microsoft</span>
            </button>
            <button class="company-roast-btn" data-company="apple">
                <img src="https://upload.wikimedia.org/wikipedia/commons/f/fa/Apple_logo_black.svg" alt="Apple" class="w-6 h-6 mr-2">
                <span>Apple</span>
            </button>
            <button class="company-roast-btn" data-company="netflix">
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg" alt="Netflix" class="w-6 h-6 mr-2">
                <span>Netflix</span>
            </button>
        </div>
        
        <!-- Roast Button -->
        <button id="roastButton" class="w-full bg-gradient-to-r from-orange-500 via-red-600 to-pink-600 hover:from-orange-600 hover:via-red-700 hover:to-pink-700 text-white font-bold py-3 px-4 rounded-lg transition-all duration-300 disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:scale-105 hover:shadow-lg disabled:hover:scale-100 relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-yellow-400/20 via-orange-400/20 to-red-400/20 animate-pulse opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
            <div class="relative z-10 flex items-center justify-center">
                <i class="fas fa-fire mr-2 text-yellow-200 drop-shadow-lg animate-bounce"></i>
                <span id="roastButtonText" class="text-lg font-extrabold tracking-wide drop-shadow-lg bg-gradient-to-r from-yellow-200 via-orange-200 to-red-200 bg-clip-text text-transparent animate-pulse">Get Roasted!</span>
            </div>
        </button>
        
        <!-- Results Section -->
        <div id="roastResults" class="hidden mt-4 p-3 bg-gradient-to-br from-gray-50 to-gray-100 rounded-lg border border-emerald-200">
            <div class="flex items-center justify-between mb-2">
                <span class="text-sm font-medium text-gray-700 flex items-center">
                    <i class="fas fa-chart-bar text-emerald-600 mr-1"></i>
                    Analysis Complete
                </span>
                <span id="roastLevel" class="text-xs px-2 py-1 rounded-full text-white"></span>
            </div>
            <p class="text-sm text-gray-600 text-center py-4">
                <i class="fas fa-external-link-alt text-emerald-600 mr-2"></i>
                Your roast is ready! Click below to view it.
            </p>
            <button id="viewRoastBtn" class="w-full bg-gradient-to-r from-emerald-600 to-emerald-700 hover:from-emerald-700 hover:to-emerald-800 text-white font-medium py-2 px-4 rounded-lg transition-all duration-200 transform hover:scale-105">
                <i class="fas fa-eye mr-2"></i>View My Roast
            </button>
        </div>
        
        <!-- Loading State -->
        <div id="roastLoading" class="hidden mt-4 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
            <p class="text-sm text-gray-600 mt-2 flex items-center justify-center">
                <i class="fas fa-cog animate-spin text-emerald-600 mr-2"></i>
                Roasting your profile...
            </p>
        </div>
        
        <!-- Error State -->
        <div id="roastError" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>
                <p id="errorMessage" class="text-sm text-red-600"></p>
            </div>
        </div>
    </div>
</div>

<!-- Floating Roast Button -->
<button id="floatingRoastBtn" class="floating-roast-btn w-16 h-16 text-white rounded-full shadow-2xl transition-all duration-300 transform hover:scale-110 hover:shadow-2xl border-2 border-white">
    <i class="fas fa-fire text-xl text-yellow-200 drop-shadow-lg"></i>
</button>

<!-- Roast Results Modal -->
<div id="roastModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden backdrop-blur-sm">
    <div id="modalContent" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full mx-4 max-h-90vh overflow-y-auto transform transition-all duration-300">
        <!-- Modal Header -->
        <div class="bg-gradient-to-r from-emerald-600 via-emerald-700 to-emerald-800 text-white p-6 rounded-t-2xl relative overflow-hidden">
            <div class="absolute inset-0 bg-gradient-to-r from-orange-500/20 via-red-500/20 to-pink-500/20 animate-pulse"></div>
            <div class="relative flex items-center justify-between">
                <div class="flex items-center">
                    <div class="relative">
                        <i class="fas fa-fire text-3xl mr-3 text-yellow-300 drop-shadow-lg animate-bounce"></i>
                        <div class="absolute -top-1 -right-1 w-3 h-3 bg-orange-400 rounded-full animate-ping"></div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold">You've Been Roasted! 🔥</h2>
                        <p class="text-emerald-100 text-sm">By <span id="modalCompanyName" class="font-semibold"></span> standards</p>
                    </div>
                </div>
                <button id="closeRoastModal" class="text-white hover:text-red-300 transition-all duration-200 text-2xl hover:rotate-90 transform">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>
        
        <!-- Modal Content -->
        <div class="p-6">
            <!-- Roast Level Badge -->
            <div class="text-center mb-6">
                <span id="modalRoastLevel" class="inline-block px-4 py-2 rounded-full text-white font-bold text-lg"></span>
            </div>
            
            <!-- Roast Summary -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-quote-left text-emerald-600 mr-2"></i>
                    The Roast
                </h3>
                <div id="modalRoastSummary" class="text-gray-700 leading-relaxed bg-gray-50 p-4 rounded-lg border-l-4 border-emerald-500"></div>
            </div>
            
            <!-- Comedy Quote -->
            <div class="mb-6">
                <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-laugh text-emerald-600 mr-2"></i>
                    Comedy Gold
                </h3>
                <div id="modalRoastQuote" class="text-gray-600 italic bg-emerald-50 p-4 rounded-lg border border-emerald-200"></div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex flex-col sm:flex-row gap-3">
                <button id="shareLinkedIn" class="flex-1 bg-gradient-to-r from-blue-600 via-blue-700 to-blue-800 hover:from-blue-700 hover:via-blue-800 hover:to-blue-900 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center justify-center group">
                    <i class="fab fa-linkedin mr-2 group-hover:animate-bounce"></i>Share on LinkedIn
                </button>
                <button id="shareTwitter" class="flex-1 bg-gradient-to-r from-gray-800 via-gray-900 to-black hover:from-gray-900 hover:via-black hover:to-gray-800 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center justify-center group">
                    <i class="fab fa-twitter mr-2 group-hover:animate-bounce"></i>Share on Twitter
                </button>
                <button id="newRoastModal" class="flex-1 bg-gradient-to-r from-emerald-600 via-emerald-700 to-emerald-800 hover:from-emerald-700 hover:via-emerald-800 hover:to-emerald-900 text-white font-medium py-3 px-4 rounded-lg transition-all duration-300 transform hover:scale-105 hover:shadow-lg flex items-center justify-center group">
                    <i class="fas fa-redo mr-2 group-hover:animate-spin"></i>New Roast
                </button>
            </div>
            
            <!-- Powered by -->
            <div class="text-center mt-6 pt-4 border-t border-gray-200">
                <p class="text-sm text-gray-500">
                    Powered by <span class="font-semibold text-emerald-600">SYNTEXA.app</span> 🚀
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // ---------- Analytics and Mapping (based on prev_dash) ----------
    function updateATSScore(score) {
        document.getElementById('atsScoreValue').textContent = score + '%';
        const bar = document.getElementById('atsScoreBar');
        bar.style.width = score + '%';
        if (score >= 80) { bar.style.background = '#059669'; }
        else if (score >= 60) { bar.style.background = '#f59e0b'; }
        else { bar.style.background = '#ef4444'; }
    }
    function renderAtsBreakdown(breakdown) {
        const items = [
            ['format','atsFormatBar','atsFormatVal'],
            ['keywords','atsKeywordsBar','atsKeywordsVal'],
            ['skills','atsSkillsBar','atsSkillsVal'],
            ['experience','atsExperienceBar','atsExperienceVal']
        ];
        items.forEach(([key, barId, valId]) => {
            const val = Math.round(Number(breakdown?.[key] || 0));
            const bar = document.getElementById(barId);
            const label = document.getElementById(valId);
            if (bar) bar.style.width = val + '%';
            if (label) label.textContent = val + '%';
        });
    }
    function renderRecommendations(analyticsData) {
        const list = document.getElementById('analyticsRecs');
        const gen = document.getElementById('generatedAt');
        const a = analyticsData || {};
        const recs = [];
        if (Array.isArray(a.ats_score?.recommendations)) recs.push(...a.ats_score.recommendations);
        if (Array.isArray(a.experience_analysis?.recommendations)) recs.push(...a.experience_analysis.recommendations);
        const html = recs.slice(0, 6).map(r => `<li>${r}</li>`).join('');
        if (list) list.innerHTML = html || '<li>No recommendations available</li>';
        if (gen && a.generated_at) gen.textContent = `Generated at ${a.generated_at}`;
    }
    function showDefaultAnalytics() {
        updateATSScore(75);
        renderAtsBreakdown({ format: 88, keywords: 78, skills: 85, experience: 83 });
        loadJobMatchesFromBackend([]);
        loadSalaryFromBackend({});
        loadSuggestionsFromBackend([]);
        renderRecommendations({});
    }
    async function loadAnalytics() {
        const analyticsDataString = '{{ analytics | tojson | safe }}';
        let analyticsData = {};
        try { analyticsData = JSON.parse(analyticsDataString); } catch (e) { showDefaultAnalytics(); return; }
        if (analyticsData && Object.keys(analyticsData).length > 0) {
            const atsScore = analyticsData.ats_score?.overall || 75;
            updateATSScore(atsScore);
            renderAtsBreakdown(analyticsData.ats_score?.breakdown || {});
            loadJobMatchesFromBackend(analyticsData.job_matches || []);
            loadSalaryFromBackend(analyticsData.salary_analysis || {});
            loadSuggestionsFromBackend(analyticsData.improvement_suggestions || []);
            renderRecommendations(analyticsData);
        } else { showDefaultAnalytics(); }
    }
    function loadJobMatchesFromBackend(jobMatches) {
        if (!jobMatches || jobMatches.length === 0) {
            jobMatches = [
                { role: 'Software Engineer', match_percentage: 85 },
                { role: 'Full Stack Developer', match_percentage: 80 },
                { role: 'Backend Developer', match_percentage: 75 }
            ];
        }
        const colors = ['job1','job2','job3'];
        const html = jobMatches.slice(0, 3).map((job, i) => `
            <div class="job-match-row ${colors[i]}">
                <span>${job.role}</span>
                <span>${job.match_percentage}% match</span>
            </div>`).join('');
        document.getElementById('jobRoleFit').innerHTML = html;
    }
    function loadSalaryFromBackend(salaryAnalysis) {
        const salaryRange = salaryAnalysis.estimated_range || '$75,000-$95,000';
        const location = salaryAnalysis.location_factor || 'United States';
        const growth = salaryAnalysis.growth_potential || '15% annually';
        document.getElementById('salaryRange').innerHTML = `
            <div class="text-xl font-bold mb-1">${salaryRange}</div>
            <div class="text-xs text-gray-500 mb-1">Based on your skills and experience</div>
            <div class="text-xs text-gray-500">Location: ${location}</div>
            <div class="text-xs text-gray-500">Growth: ${growth}</div>`;
    }
    function loadSuggestionsFromBackend(suggestions) {
        if (!suggestions || suggestions.length === 0) {
            suggestions = [
                { priority: 'High', suggestion: 'Add more quantified achievements' },
                { priority: 'Medium', suggestion: 'Include relevant certifications' },
                { priority: 'Low', suggestion: 'Update skills with trending technologies' }
            ];
        }
        const map = { High: ['tip-high', 'fa-exclamation-triangle'], Medium: ['tip-medium', 'fa-lightbulb'], Low: ['tip-low', 'fa-check'] };
        const html = suggestions.slice(0, 4).map(s => {
            const cls = map[s.priority]?.[0] || 'tip-low';
            const icon = map[s.priority]?.[1] || 'fa-check';
            return `<div class="improvement-tip ${cls}"><i class="fas ${icon} mr-2"></i>${s.suggestion}</div>`;
        }).join('');
        const target = document.getElementById('quickSuggestionsOverview');
        if (target) target.innerHTML = html;
    }

    // ---------- Populate Overview Tabs from resume_data ----------
    function populateFromResume() {
        let data = {};
        try { data = JSON.parse('{{ resume_data | tojson | safe }}') || {}; } catch (e) { data = {}; }
        const personal = (data.parsed_data && data.parsed_data.personal_info) || {};
        
        // Skills (fallback: server-side markup already present)
        const skills = (data.parsed_data && data.parsed_data.skills) || [];
        if (skills.length) {
            const skillsHtml = skills.slice(0, 50).map(skill => `<span class=\"bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium\">${skill}</span>`).join('');
            const skillsContainer = document.getElementById('skillsContainer');
            if (skillsContainer) skillsContainer.innerHTML = skillsHtml;
        }
        
        // Experience (fallback server-side present)
        const experience = (data.parsed_data && data.parsed_data.experience) || [];
        if (experience.length) {
            const expHtml = experience.map(exp => `
                <div class=\"border-l-4 border-emerald-500 pl-4 py-2\">
                    <div class=\"flex justify-between items-start mb-1\">
                        <div>
                            <div class=\"font-semibold text-gray-900\">${exp.title || ''}</div>
                            <div class=\"text-gray-600 text-sm\">${exp.company || ''}</div>
                        </div>
                        <span class=\"text-xs text-gray-500 whitespace-nowrap\">${exp.duration || ''}</span>
                    </div>
                    ${Array.isArray(exp.responsibilities) ? `<ul class='list-disc list-inside mt-1 space-y-1'>${exp.responsibilities.map(r => `<li class='text-gray-700'>${r}</li>`).join('')}</ul>` : ''}
                    ${Array.isArray(exp.achievements) ? `<div class='mt-2 text-sm'><span class='font-medium'>Key Achievements:</span><ul class='list-disc list-inside mt-1 space-y-1'>${exp.achievements.map(a => `<li class='text-gray-700'>${a}</li>`).join('')}</ul></div>` : ''}
                    ${Array.isArray(exp.technologies) ? `<div class='mt-2 flex flex-wrap gap-2'>${exp.technologies.map(t => `<span class='bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs'>${t}</span>`).join('')}</div>` : ''}
                </div>`).join('');
            const expContainer = document.getElementById('experienceContainer');
            if (expContainer) expContainer.innerHTML = expHtml;
        }
        
        // Update profile information with better fallbacks
        const profileElements = {
            profileName: personal.name || 'User Name',
            profileEmail: personal.email || 'user@example.com'
        };
        
        // Update profile elements that still use JavaScript
        Object.entries(profileElements).forEach(([elementId, value]) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        });
        
        // Update profile avatars with consistent image source
        const avatarSeed = encodeURIComponent(personal.email || personal.name || 'default-user');
        const avatarUrl = `https://api.dicebear.com/8.x/personas/svg?seed=${avatarSeed}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50`;
        
        // Update all avatar images
        const avatarElements = ['profileAvatar', 'headerAvatar', 'sidebarAvatar'];
        avatarElements.forEach(avatarId => {
            const avatar = document.getElementById(avatarId);
            if (avatar) {
                avatar.src = avatarUrl;
                avatar.onerror = function() {
                    // Fallback to a different avatar service if DiceBear fails
                    this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(personal.name || 'User')}&background=059669&color=fff&size=128&rounded=true`;
                };
            }
        });
        
        // Add hover effects and animations
        const profileBtn = document.getElementById('profileAvatarBtn');
        if (profileBtn) {
            profileBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05)';
                this.style.transition = 'transform 0.2s ease';
            });
            profileBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        }
    }

    // ---------- Tabs and Profile Menu ----------
    function initTabs() {
        const buttons = Array.from(document.querySelectorAll('.tab-btn'));
        const panels = {
            summary: document.getElementById('overviewSummary'),
            skills: document.getElementById('overviewSkills'),
            experience: document.getElementById('overviewExperience')
        };
        buttons.forEach(btn => btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.getAttribute('data-tab');
            Object.keys(panels).forEach(key => {
                if (panels[key]) panels[key].classList.toggle('hidden', key !== tab);
            });
        }));
    }
    function initProfileMenu() {
        const btn = document.getElementById('profileAvatarBtn');
        const menu = document.getElementById('profileMenu');
        if (!btn || !menu) return;
        
        btn.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('profile-menu-enter');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('profile-menu-enter');
            }
        });
        
        document.addEventListener('click', (e) => { 
            if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
                menu.classList.remove('profile-menu-enter');
            }
        });
        
        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                menu.classList.remove('profile-menu-enter');
            }
        });
    }

    // Handle user logout
    function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            authManager.logout();
        }
    }

    // Authentication check on page load
    function checkAuthentication() {
        if (!authManager.isAuthenticated()) {
            authManager.redirectToLogin();
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Check authentication first
        if (!checkAuthentication()) {
            return;
        }
        
        loadAnalytics();
        populateFromResume();
        initTabs();
        initProfileMenu();
        initRoastWidget();
    });

    // ---------- Company Roast Widget Functionality ----------
    function initRoastWidget() {
        const floatingBtn = document.getElementById('floatingRoastBtn');
        const widget = document.getElementById('companyRoastWidget');
        const closeBtn = document.getElementById('closeRoastWidget');
        const roastBtn = document.getElementById('roastButton');
        const companyBtns = document.querySelectorAll('.company-roast-btn');
        const urlInput = document.getElementById('linkedinUrlInput');
        
        let selectedCompany = null;
        
        // Show/hide widget
        floatingBtn.addEventListener('click', () => {
            widget.classList.add('show');
            floatingBtn.classList.add('hidden');
        });
        
        closeBtn.addEventListener('click', () => {
            widget.classList.remove('show');
            floatingBtn.classList.remove('hidden');
            resetRoastWidget();
        });
        
        // Company selection
        companyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                companyBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedCompany = btn.dataset.company;
                updateRoastButton();
            });
        });
        
        // URL input validation
        urlInput.addEventListener('input', updateRoastButton);
        
        function updateRoastButton() {
            const hasUrl = urlInput.value.trim() !== '';
            const hasCompany = selectedCompany !== null;
            roastBtn.disabled = !(hasUrl && hasCompany);
            
            if (hasUrl && hasCompany) {
                roastBtn.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-400/20 via-orange-400/20 to-red-400/20 animate-pulse opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10 flex items-center justify-center">
                        <i class="fas fa-fire mr-2 text-yellow-200 drop-shadow-lg animate-bounce"></i>
                        <span class="text-lg font-extrabold tracking-wide drop-shadow-lg bg-gradient-to-r from-yellow-200 via-orange-200 to-red-200 bg-clip-text text-transparent animate-pulse">Get Roasted by ${selectedCompany.charAt(0).toUpperCase() + selectedCompany.slice(1)}!</span>
                    </div>`;
            } else {
                roastBtn.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-400/20 via-orange-400/20 to-red-400/20 animate-pulse opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10 flex items-center justify-center">
                        <i class="fas fa-fire mr-2 text-yellow-200 drop-shadow-lg animate-bounce"></i>
                        <span class="text-lg font-extrabold tracking-wide drop-shadow-lg bg-gradient-to-r from-yellow-200 via-orange-200 to-red-200 bg-clip-text text-transparent animate-pulse">Get Roasted!</span>
                    </div>`;
            }
        }
        
        // Roast functionality
        roastBtn.addEventListener('click', async () => {
            if (roastBtn.disabled) return;
            
            const url = urlInput.value.trim();
            if (!url || !selectedCompany) return;
            
            // Show loading state
            showRoastLoading();
            
            try {
                const response = await fetch('/api/roast-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        profile_url: url,
                        user_interests: [],
                        tone: 'witty',
                        company: selectedCompany
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showRoastResults(data);
                } else {
                    showRoastError(data.error || 'Failed to roast profile');
                }
            } catch (error) {
                console.error('Roast error:', error);
                showRoastError('Network error. Please try again.');
            }
        });
        
        // View roast button click
        document.getElementById('viewRoastBtn').addEventListener('click', () => {
            showRoastModal();
        });
        
        // Modal functionality with cool animations
        document.getElementById('closeRoastModal').addEventListener('click', () => {
            closeModalWithAnimation();
        });
        
        // Close modal when clicking outside
        document.getElementById('roastModal').addEventListener('click', (e) => {
            if (e.target.id === 'roastModal') {
                closeModalWithAnimation();
            }
        });
        
        // ESC key to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('roastModal').classList.contains('hidden')) {
                closeModalWithAnimation();
            }
        });
        
        function closeModalWithAnimation() {
            const modal = document.getElementById('roastModal');
            const modalContent = document.getElementById('modalContent');
            
            modal.classList.add('backdrop-exit');
            modalContent.classList.add('modal-exit');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('backdrop-exit', 'backdrop-enter');
                modalContent.classList.remove('modal-exit', 'modal-enter');
            }, 300);
        }
        
        // LinkedIn share functionality - FIXED
        document.getElementById('shareLinkedIn').addEventListener('click', () => {
            const companyName = selectedCompany ? selectedCompany.charAt(0).toUpperCase() + selectedCompany.slice(1) : 'Tech Giants';
            const roastQuote = document.getElementById('modalRoastQuote').textContent;
            
            const linkedInText = `🔥 Just got roasted by ${companyName} standards!

"${roastQuote}"

Sometimes the truth hurts, but it's what we need to grow! 💪

Ready to level up your LinkedIn game? Get your profile roasted too!

#LinkedInRoast #ProfessionalGrowth #CareerDevelopment #TechCareers #ProfileOptimization

Powered by SYNTEXA.app 🚀`;
            
            // Use the correct LinkedIn sharing URL format
            const encodedText = encodeURIComponent(linkedInText);
            const encodedUrl = encodeURIComponent('https://syntexa.app');
            const linkedInUrl = `https://www.linkedin.com/feed/?shareActive=true&text=${encodedText}`;
            
            window.open(linkedInUrl, '_blank', 'width=600,height=600,scrollbars=yes,resizable=yes');
        });
        
        // Twitter share functionality
        document.getElementById('shareTwitter').addEventListener('click', () => {
            const companyName = selectedCompany ? selectedCompany.charAt(0).toUpperCase() + selectedCompany.slice(1) : 'Tech Giants';
            const roastQuote = document.getElementById('modalRoastQuote').textContent;
            const twitterText = `🔥 Just got roasted by ${companyName}! "${roastQuote}" 

Ready for your roast? 

#LinkedInRoast #SYNTEXA

syntexa.app`;
            
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}`;
            window.open(twitterUrl, '_blank');
        });
        
        // New roast functionality
        document.getElementById('newRoastModal').addEventListener('click', () => {
            closeModalWithAnimation();
            setTimeout(() => {
                resetRoastWidget();
            }, 300);
        });
        
        function showRoastLoading() {
            document.getElementById('roastLoading').classList.remove('hidden');
            document.getElementById('roastResults').classList.add('hidden');
            document.getElementById('roastError').classList.add('hidden');
            roastBtn.disabled = true;
        }
        
        function showRoastResults(data) {
            document.getElementById('roastLoading').classList.add('hidden');
            document.getElementById('roastError').classList.add('hidden');
            
            const results = document.getElementById('roastResults');
            const roast = data.roast;
            
            // Store roast data globally for modal
            window.currentRoast = roast;
            window.currentCompany = selectedCompany;
            
            // Set roast level
            const levelElement = document.getElementById('roastLevel');
            levelElement.textContent = roast.roast_level || 'medium';
            levelElement.className = `text-xs px-2 py-1 rounded-full text-white ${getLevelClass(roast.roast_level)}`;
            
            results.classList.remove('hidden');
            roastBtn.disabled = false;
        }
        
        function showRoastModal() {
            const roast = window.currentRoast;
            const company = window.currentCompany;
            
            if (!roast) return;
            
            // Populate modal content
            document.getElementById('modalCompanyName').textContent = company ? company.charAt(0).toUpperCase() + company.slice(1) : 'Tech Giants';
            document.getElementById('modalRoastLevel').textContent = roast.roast_level || 'Medium';
            document.getElementById('modalRoastLevel').className = `inline-block px-4 py-2 rounded-full text-white font-bold text-lg ${getLevelClass(roast.roast_level)}`;
            document.getElementById('modalRoastSummary').textContent = roast.complete_roast_summary || 'No roast available';
            document.getElementById('modalRoastQuote').textContent = roast.comedy_gold_quote || 'No quote available';
            
            // Show modal with cool animation
            const modal = document.getElementById('roastModal');
            const modalContent = document.getElementById('modalContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('backdrop-enter');
            modalContent.classList.add('modal-enter');
            
            // Remove animation classes after animation completes
            setTimeout(() => {
                modal.classList.remove('backdrop-enter');
                modalContent.classList.remove('modal-enter');
            }, 400);
        }
        
        function showRoastError(message) {
            document.getElementById('roastLoading').classList.add('hidden');
            document.getElementById('roastResults').classList.add('hidden');
            
            const errorDiv = document.getElementById('roastError');
            document.getElementById('errorMessage').textContent = message;
            errorDiv.classList.remove('hidden');
            
            roastBtn.disabled = false;
        }
        
        function resetRoastWidget() {
            selectedCompany = null;
            urlInput.value = '';
            companyBtns.forEach(btn => btn.classList.remove('selected'));
            document.getElementById('roastResults').classList.add('hidden');
            document.getElementById('roastLoading').classList.add('hidden');
            document.getElementById('roastError').classList.add('hidden');
            window.currentRoast = null;
            window.currentCompany = null;
            updateRoastButton();
        }
        
        function getLevelClass(level) {
            const classes = {
                'mild': 'bg-emerald-500',
                'medium': 'bg-yellow-500',
                'spicy': 'bg-orange-500',
                'savage': 'bg-red-500',
                'nuclear': 'bg-purple-500'
            };
            return classes[level] || 'bg-emerald-500';
        }
    }
</script>
</body>
</html>