<!DOCTYPE html>
<html>
<head>
    <title>Cold Email Generator â€¢ Syntexa</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .emerald { color: #059669; }
        .emerald-bg { background: #059669; }
        .brand-syn { color: #059669; }
        .brand-texa { color: #111827; }
        .card { background: #fff; border-radius: 1.25rem; box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.08); transition: box-shadow 0.3s; }
        .card:hover { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12); }
        .header-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; text-decoration: none; }
        .header-btn.improve { background: #f0fdf4; color: #059669; border: 1px solid #059669; }
        .header-btn.improve:hover { background: #059669; color: #fff; }
        
        /* Cool loading animations */
        .loading-container {
            position: relative;
            overflow: hidden;
        }
        .loading-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #059669;
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        .particle:nth-child(1) { left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 40%; animation-delay: 0.5s; }
        .particle:nth-child(3) { left: 60%; animation-delay: 1s; }
        .particle:nth-child(4) { left: 80%; animation-delay: 1.5s; }
        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); opacity: 1; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 0.7; }
        }
        
        .typing-animation {
            overflow: hidden;
            border-right: 2px solid #059669;
            white-space: nowrap;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #059669; }
        }
        
        .success-animation {
            animation: successPop 0.5s ease-out;
        }
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .update-badge {
            animation: updatePulse 2s ease-in-out;
        }
        @keyframes updatePulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .action-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .action-btn:hover::before {
            left: 100%;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <a href="/" class="flex items-center">
                    <span class="text-2xl font-extrabold tracking-tight">
                        <span class="brand-syn">Syn</span><span class="brand-texa">texa</span>
                    </span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/email-history/{{resume_id}}" class="header-btn improve flex items-center">
                    <i class="fas fa-history mr-2"></i>View History
                </a>
                <a href="/dashboard/{{resume_id}}" class="header-btn improve flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-extrabold tracking-tight text-gray-900">Cold Email Generator</h1>
            <p class="text-gray-600 mt-2">Create compelling cold emails that get responses</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Resume Summary -->
            <div class="card p-8">
                <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                    <div class="text-2xl font-bold">Resume Summary</div>
                    <div class="text-sm text-gray-200">Your profile information for personalization</div>
                </div>
                
                {% if resume_data and resume_data.parsed_data %}
                <div class="space-y-4">
                    <div>
                        <h3 class="font-medium text-gray-700">Name</h3>
                        <p class="text-gray-900">{{ resume_data.parsed_data.personal_info.name if resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.name else 'Not provided' }}</p>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700">Current Role</h3>
                        <p class="text-gray-900">{{ resume_data.parsed_data.experience[0].title if resume_data.parsed_data.experience and resume_data.parsed_data.experience|length > 0 else 'Not provided' }}</p>
                    </div>
                    <div>
                        <h3 class="font-medium text-gray-700">Key Skills</h3>
                        <div class="flex flex-wrap gap-2">
                            {% if resume_data.parsed_data.skills %}
                                {% set skills_list = [] %}
                                {% if resume_data.parsed_data.skills is mapping %}
                                    {% for category, skills in resume_data.parsed_data.skills.items() %}
                                        {% if skills is iterable and skills is not string %}
                                            {% for skill in skills[:3] %}
                                                {% if skills_list|length < 5 %}
                                                    {% set _ = skills_list.append(skill) %}
                                                {% endif %}
                                            {% endfor %}
                                        {% endif %}
                                    {% endfor %}
                                {% elif resume_data.parsed_data.skills is iterable and resume_data.parsed_data.skills is not string %}
                                    {% for skill in resume_data.parsed_data.skills[:5] %}
                                        {% set _ = skills_list.append(skill) %}
                                    {% endfor %}
                                {% endif %}
                                
                                {% if skills_list %}
                                    {% for skill in skills_list %}
                                        <span class="bg-emerald-100 text-emerald-800 text-sm px-3 py-1 rounded-full font-medium">
                                            {{ skill }}
                                        </span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-gray-500">No skills available</span>
                                {% endif %}
                            {% else %}
                                <span class="text-gray-500">No skills listed</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-gray-500">
                    <p>Resume data not available</p>
                </div>
                {% endif %}
            </div>

            <!-- Email Generator Form -->
            <div class="space-y-6">
                <div class="card p-8">
                    <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                        <div class="text-2xl font-bold">Generate Cold Email</div>
                        <div class="text-sm text-gray-200">AI-powered personalized cold emails</div>
                    </div>
                    
                    <form id="emailForm" class="space-y-6">
                        <input type="hidden" id="resumeId" value="{{resume_id}}">

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Recipient's Name</label>
                            <input type="text" id="recipientName" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required
                                   placeholder="e.g. John Smith">
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Company Name</label>
                            <input type="text" id="companyName" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required
                                   placeholder="e.g. Tech Corp">
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Target Goal</label>
                            <input type="text" id="role" 
                                   class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required
                                   placeholder="e.g. Schedule a call, Product demo, Partnership discussion">
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Additional Context</label>
                            <textarea id="additionalContext" 
                                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 h-24"
                                    placeholder="e.g. I noticed you're expanding to new markets, and I'd love to partner up. I have experience with 15+ successful partnerships and can help scale your operations by 40%..."></textarea>
                        </div>

                        <div>
                            <label class="block text-gray-700 mb-2 font-medium">Email Style</label>
                            <select id="emailStyle" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500">
                                <option value="professional">Professional</option>
                                <option value="conversational">Conversational</option>
                                <option value="direct">Direct</option>
                            </select>
                        </div>

                        <button type="submit" 
                                class="w-full bg-emerald-600 text-white py-3 px-6 rounded-lg hover:bg-emerald-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                            <i class="fas fa-paper-plane mr-2"></i>Generate Email
                        </button>
                    </form>
                </div>

                <!-- Loading State -->
                <div id="loadingState" class="card p-8 hidden">
                    <div class="text-center loading-container">
                        <div class="loading-particles">
                            <div class="particle"></div>
                            <div class="particle"></div>
                            <div class="particle"></div>
                            <div class="particle"></div>
                        </div>
                        <div class="relative z-10">
                            <div class="mb-6">
                                <i class="fas fa-rocket text-6xl text-emerald-600 animate-bounce"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2 typing-animation">Crafting your personalized cold email...</h3>
                            <p class="text-gray-600">Our AI is analyzing your profile and creating a compelling message that will get responses</p>
                            <div class="mt-6 flex justify-center">
                                <div class="flex space-x-2">
                                    <div class="w-3 h-3 bg-emerald-600 rounded-full animate-bounce"></div>
                                    <div class="w-3 h-3 bg-emerald-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-3 h-3 bg-emerald-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Generated Email - Centered below -->
        <div id="generatedEmail" class="mt-8 hidden">
            <div class="card p-8 max-w-4xl mx-auto">
                <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                    <div class="text-2xl font-bold flex items-center justify-between">
                        <span>Generated Email</span>
                        <span id="updateBadge" class="text-xs bg-emerald-500 px-2 py-1 rounded-full update-badge hidden">Updated</span>
                    </div>
                    <div id="subjectLine" class="text-sm text-gray-200 hidden">
                        <span class="font-medium">Subject:</span> <span id="subjectText"></span>
                    </div>
                    <div class="text-sm text-gray-200">Your personalized cold email is ready</div>
                </div>
                
                <div id="emailContent" class="prose max-w-none border border-gray-200 p-6 bg-gray-50 rounded-lg mb-6 min-h-[400px]">
                    <!-- Email content will be inserted here -->
                </div>
                
                <div class="flex gap-4 mb-6">
                    <button onclick="copyEmail()" 
                            class="flex-1 bg-gray-600 text-white py-3 px-4 rounded-lg hover:bg-gray-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                        <i class="fas fa-copy mr-2"></i>Copy Email
                    </button>
                    <button onclick="copySubject()" 
                            class="flex-1 bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                        <i class="fas fa-tag mr-2"></i>Copy Subject
                    </button>
                    <button onclick="sendEmail()" 
                            class="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                        <i class="fas fa-paper-plane mr-2"></i>Send Email
                    </button>
                    <button onclick="regenerateEmail()" 
                            class="flex-1 bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                        <i class="fas fa-redo mr-2"></i>Regenerate
                    </button>
                </div>
                
                <!-- Feedback Section for Improvement -->
                <div class="border-t border-gray-200 pt-6">
                    <h3 class="font-semibold mb-3 text-gray-900">Want to improve the email?</h3>
                    <textarea id="feedbackInput" 
                            class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 h-24 mb-4"
                            placeholder="Provide feedback for improvements (e.g., make it more formal, add specific achievements, etc.)"></textarea>
                    <button onclick="regenerateWithFeedback()"
                            class="w-full bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                        <i class="fas fa-wand-magic-sparkles mr-2"></i>Regenerate with Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('emailForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating...';
            
            // Show loading state
            document.getElementById('generatedEmail').classList.add('hidden');
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('loadingState').scrollIntoView({ behavior: 'smooth' });
            
            try {
                const response = await fetch(`/email/${document.getElementById('resumeId').value}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_name: document.getElementById('recipientName').value,
                        company_name: document.getElementById('companyName').value,
                        role: document.getElementById('role').value,
                        additional_context: document.getElementById('additionalContext').value,
                        email_style: document.getElementById('emailStyle').value
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('emailContent').innerHTML = result.email
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    // Handle subject line if provided
                    if (result.subject_line) {
                        document.getElementById('subjectText').textContent = result.subject_line;
                        document.getElementById('subjectLine').classList.remove('hidden');
                    }
                    
                    document.getElementById('loadingState').classList.add('hidden');
                    document.getElementById('generatedEmail').classList.remove('hidden');
                    
                    // Scroll to the generated email
                    document.getElementById('generatedEmail').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                } else {
                    alert('Error: ' + (result.error || 'Failed to generate email'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate email. Please try again.');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Generate Email';
                document.getElementById('loadingState').classList.add('hidden');
            }
        });

        function copyEmail() {
            const emailText = document.getElementById('emailContent').innerText;
            navigator.clipboard.writeText(emailText)
                .then(() => {
                    // Show success message
                    const button = event.target;
                    const originalText = button.innerHTML;
                    button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                    button.classList.add('bg-green-600', 'success-animation');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-green-600', 'success-animation');
                    }, 2000);
                })
                .catch(err => {
                    console.error('Failed to copy:', err);
                    alert('Failed to copy email');
                });
        }

        function copySubject() {
            const subjectText = document.getElementById('subjectText').textContent;
            if (subjectText) {
                navigator.clipboard.writeText(subjectText)
                    .then(() => {
                        const button = event.target;
                        const originalText = button.innerHTML;
                        button.innerHTML = '<i class="fas fa-check mr-2"></i>Copied!';
                        button.classList.add('bg-green-600', 'success-animation');
                        setTimeout(() => {
                            button.innerHTML = originalText;
                            button.classList.remove('bg-green-600', 'success-animation');
                        }, 2000);
                    })
                    .catch(err => console.error('Failed to copy subject:', err));
            } else {
                alert('No subject line available to copy');
            }
        }

        function sendEmail() {
            const emailText = document.getElementById('emailContent').innerText;
            const subjectText = document.getElementById('subjectText').textContent || 
                               `${document.getElementById('role').value} - ${document.getElementById('recipientName').value}`;
            
            // Get recipient email - you might want to add this as an input field
            const recipientEmail = prompt('Please enter recipient email address:');
            if (!recipientEmail) {
                alert('Recipient email is required to send the email');
                return;
            }

            const button = event.target;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

            authManager.authFetch('/send-email', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    recipient_email: recipientEmail,
                    subject: subjectText,
                    body: emailText
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    button.innerHTML = '<i class="fas fa-check mr-2"></i>Sent!';
                    button.classList.add('bg-green-600', 'success-animation');
                    alert('Email sent successfully!');
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.classList.remove('bg-green-600', 'success-animation');
                        button.disabled = false;
                    }, 3000);
                } else {
                    alert('Error: ' + (data.error || 'Failed to send email'));
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Failed to send email. Please try again.');
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        async function regenerateEmail() {
            // Trigger form submission again
            document.getElementById('emailForm').dispatchEvent(new Event('submit'));
        }
        
        async function regenerateWithFeedback() {
            const feedback = document.getElementById('feedbackInput').value;
            if (!feedback.trim()) {
                alert('Please provide feedback for improvements');
                return;
            }
            
            const submitButton = document.querySelector('button[onclick="regenerateWithFeedback()"]');
            const originalText = submitButton.innerHTML;
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Regenerating...';
            
            try {
                const response = await fetch(`/email/${document.getElementById('resumeId').value}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        recipient_name: document.getElementById('recipientName').value,
                        company_name: document.getElementById('companyName').value,
                        role: document.getElementById('role').value,
                        additional_context: document.getElementById('additionalContext').value + '\n\nFeedback for improvement: ' + feedback,
                        email_style: document.getElementById('emailStyle').value
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    document.getElementById('emailContent').innerHTML = result.email
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    
                    // Handle subject line if provided
                    if (result.subject_line) {
                        document.getElementById('subjectText').textContent = result.subject_line;
                        document.getElementById('subjectLine').classList.remove('hidden');
                    }
                    
                    document.getElementById('feedbackInput').value = '';
                    
                    // Show update badge
                    const updateBadge = document.getElementById('updateBadge');
                    updateBadge.classList.remove('hidden');
                    setTimeout(() => {
                        updateBadge.classList.add('hidden');
                    }, 3000);
                    
                    // Show success animation
                    submitButton.innerHTML = '<i class="fas fa-check mr-2"></i>Success!';
                    submitButton.classList.add('bg-green-600', 'success-animation');
                    setTimeout(() => {
                        submitButton.innerHTML = originalText;
                        submitButton.classList.remove('bg-green-600', 'success-animation');
                    }, 2000);
                } else {
                    alert('Error: ' + (result.error || 'Failed to regenerate email'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to regenerate email. Please try again.');
            } finally {
                submitButton.disabled = false;
                if (!submitButton.classList.contains('bg-green-600')) {
                    submitButton.innerHTML = originalText;
                }
            }
        }

        // Authentication check on page load
        document.addEventListener('DOMContentLoaded', function() {
            if (!authManager.isAuthenticated()) {
                authManager.redirectToLogin();
            }
        });
    </script>
</body>
</html>