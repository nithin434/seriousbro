<!DOCTYPE html>
<html>
<head>
    <title>Dashboard | Syntexa</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="/static/js/auth.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .brand-syn { color: #10B981; }
        .brand-texa { color: #1F2937; }
        .sidebar { background-color: #ffffff; border-right: 1px solid #E5E7EB; }
        .sidebar a { color: #4B5563; transition: all 0.2s ease; }
        .sidebar a:hover { background-color: #F3F4F6; color: #1F2937; }
        .sidebar a.active { background-color: #ECFDF5; color: #059669; font-weight: 600; }
        .sidebar-icon { color: #6B7280; }
        .sidebar a:hover .sidebar-icon, .sidebar a.active .sidebar-icon { color: #059669; }
        .card { background-color: #ffffff; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); transition: box-shadow 0.3s ease; }
        .card:hover { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .header-btn { border-radius: 0.5rem; font-weight: 600; transition: all 0.2s ease; text-decoration: none; border: 1px solid transparent; }
        .header-btn.improve { background-color: #ECFDF5; color: #059669; border-color: #A7F3D0; }
        .header-btn.improve:hover { background-color: #D1FAE5; color: #047857; }
        .header-btn.ats { background-color: #374151; color: #ffffff; }
        .header-btn.ats:hover { background-color: #1F2937; }
        .tab-btn { background-color: #F3F4F6; color: #374151; border-radius: 0.5rem; padding: 0.5rem 1.25rem; font-weight: 600; transition: all 0.2s ease; }
        .tab-btn.active, .tab-btn:hover { background-color: #10B981; color: #ffffff; }
        .metric-track { background-color: #E5E7EB; border-radius: 9999px; height: 8px; overflow: hidden; }
        .metric-fill { height: 100%; border-radius: 9999px; background-color: #10B981; transition: width 0.8s cubic-bezier(0.25, 1, 0.5, 1); }
        .improvement-tip { border-radius: 0.75rem; padding: 1rem; margin-bottom: 0.75rem; display: flex; align-items: center; font-weight: 500; border-left-width: 4px; }
        .tip-high { background-color: #FEF2F2; color: #991B1B; border-color: #F87171; }
        .tip-medium { background-color: #FFFBEB; color: #92400E; border-color: #FBBF24; }
        .tip-low { background-color: #ECFDF5; color: #065F46; border-color: #34D399; }
        .quick-action-btn { background-color: #F9FAFB; color: #374151; border: 1px solid #E5E7EB; border-radius: 0.75rem; font-weight: 600; transition: all 0.2s ease; text-decoration: none; }
        .quick-action-btn:hover { border-color: #10B981; color: #10B981; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(16, 185, 129, 0.1); }
        .profile-menu-enter { animation: fadeInScale 0.2s ease-out; }
        @keyframes fadeInScale {
            from { opacity: 0; transform: scale(0.95) translateY(-10px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }
    </style>
</head>
<body class="bg-gray-100">
<div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="sidebar w-64 flex-col justify-between py-6 px-4 hidden sm:flex">
        <div>
            <div class="flex items-center mb-8 px-2">
                <span class="text-2xl font-extrabold tracking-tight"><span class="brand-syn">Syn</span><span class="brand-texa">texa</span></span>
            </div>
            <nav class="flex flex-col gap-1">
                <a href="/dashboard/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-3 py-2.5 rounded-lg active">
                    <i class="fas fa-th-large fa-fw sidebar-icon mr-3"></i>Dashboard
                </a>
                <a href="/generate-ats-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-file-alt fa-fw sidebar-icon mr-3"></i>ATS Resume
                </a>
                <a href="/upload" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-upload fa-fw sidebar-icon mr-3"></i>Upload New
                </a>
                <a href="/improve-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-edit fa-fw sidebar-icon mr-3"></i>Improve Resume
                </a>
                <a href="/cover-letter/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-envelope fa-fw sidebar-icon mr-3"></i>Cover Letter
                </a>
                <a href="/email/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-paper-plane fa-fw sidebar-icon mr-3"></i>Cold Email
                </a>
                <a href="/analyze-job/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-search fa-fw sidebar-icon mr-3"></i>Analyze Job
                </a>
                 <a href="/profile-analysis" class="flex items-center px-3 py-2.5 rounded-lg">
                    <i class="fas fa-microscope fa-fw sidebar-icon mr-3"></i>Analyze Profile
                </a>
            </nav>
        </div>
        <div class="flex items-center gap-3 bg-gray-100 rounded-lg p-3">
             <img id="sidebarAvatar" class="w-10 h-10 rounded-full" alt="Profile" 
                 src="https://api.dicebear.com/8.x/personas/svg?seed={{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'default-user' }}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50" />
            <div class="flex-1 min-w-0">
                <div class="font-semibold text-gray-800 text-sm truncate">
                    {{ resume_data.parsed_data.personal_info.name if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.name else 'User' }}
                </div>
                <div class="text-xs text-gray-500 truncate">
                    {{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'user@example.com' }}
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col">
        <!-- Top Bar -->
        <header class="flex items-center justify-between px-6 sm:px-10 py-4 bg-white border-b border-gray-200">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">Dashboard</h1>
                <p class="text-sm text-gray-500">Welcome back, let's get you hired!</p>
            </div>
            <div class="flex items-center gap-4">
                <a href="/improve-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="header-btn improve flex items-center px-4 py-2">
                    <i class="fas fa-magic mr-2"></i>Improve
                </a>
                <a href="/generate-ats-resume/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="header-btn ats flex items-center px-4 py-2">
                    <i class="fas fa-file-alt mr-2"></i>ATS Resume
                </a>
                <div class="relative">
                    <button id="profileAvatarBtn" class="w-10 h-10 rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-emerald-500">
                        <img id="headerAvatar" class="w-full h-full object-cover rounded-full" alt="Profile" 
                             src="https://api.dicebear.com/8.x/personas/svg?seed={{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'default-user' }}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50" />
                    </button>
                    <div id="profileMenu" class="absolute right-0 mt-2 w-80 bg-white rounded-xl shadow-lg border border-gray-100 p-4 hidden z-50 origin-top-right">
                        <div class="flex items-center gap-4 mb-4 pb-4 border-b border-gray-200">
                            <img id="profileAvatar" class="w-16 h-16 rounded-full" alt="Profile Avatar" 
                                 src="https://api.dicebear.com/8.x/personas/svg?seed={{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'default-user' }}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50" />
                            <div class="flex-1 min-w-0">
                                <div id="profileName" class="font-bold text-lg text-gray-800 truncate">
                                    {{ resume_data.parsed_data.personal_info.name if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.name else 'User' }}
                                </div>
                                <div id="profileEmail" class="text-sm text-gray-500 truncate">
                                    {{ resume_data.parsed_data.personal_info.email if resume_data and resume_data.parsed_data and resume_data.parsed_data.personal_info and resume_data.parsed_data.personal_info.email else 'user@example.com' }}
                                </div>
                            </div>
                        </div>
                        
                        <div class="space-y-2 text-sm">
                            <a href="/settings" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-gray-600">
                                <i class="fas fa-cog fa-fw mr-3"></i>Account Settings
                            </a>
                            <a href="/help" class="flex items-center p-2 rounded-lg hover:bg-gray-100 text-gray-600">
                                <i class="fas fa-question-circle fa-fw mr-3"></i>Help Center
                            </a>
                        </div>
                        
                        <div class="border-t border-gray-200 mt-3 pt-3">
                            <button onclick="handleLogout()" class="w-full text-left flex items-center p-2 rounded-lg hover:bg-red-50 text-red-600 transition-colors">
                                <i class="fas fa-sign-out-alt fa-fw mr-3"></i>Logout
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>
        <!-- Dashboard Cards -->
        <main class="flex-1 p-10 bg-gray-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Resume Overview (Main Card) -->
                <div class="md:col-span-2 card p-6 sm:p-8">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Resume Overview</h2>
                            <p class="text-sm text-gray-500">AI-powered analysis of your current resume</p>
                        </div>
                        <div class="flex items-center gap-2">
                            <button class="tab-btn active" data-tab="summary">Summary</button>
                            <button class="tab-btn" data-tab="skills">Skills</button>
                            <button class="tab-btn" data-tab="experience">Experience</button>
                        </div>
                    </div>

                    <!-- Summary Tab -->
                    <div id="overviewSummary">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">ATS Score Breakdown</h3>
                                <div id="atsBreakdown" class="space-y-4">
                                    <div class="metric">
                                        <div class="flex justify-between items-center mb-1 text-sm">
                                            <span class="font-medium text-gray-600">Format</span>
                                            <span id="atsFormatVal" class="font-semibold text-gray-800">--%</span>
                                        </div>
                                        <div class="metric-track"><div id="atsFormatBar" class="metric-fill"></div></div>
                                    </div>
                                     <div class="metric">
                                        <div class="flex justify-between items-center mb-1 text-sm">
                                            <span class="font-medium text-gray-600">Keywords</span>
                                            <span id="atsKeywordsVal" class="font-semibold text-gray-800">--%</span>
                                        </div>
                                        <div class="metric-track"><div id="atsKeywordsBar" class="metric-fill"></div></div>
                                    </div>
                                     <div class="metric">
                                        <div class="flex justify-between items-center mb-1 text-sm">
                                            <span class="font-medium text-gray-600">Skills</span>
                                            <span id="atsSkillsVal" class="font-semibold text-gray-800">--%</span>
                                        </div>
                                        <div class="metric-track"><div id="atsSkillsBar" class="metric-fill"></div></div>
                                    </div>
                                     <div class="metric">
                                        <div class="flex justify-between items-center mb-1 text-sm">
                                            <span class="font-medium text-gray-600">Experience</span>
                                            <span id="atsExperienceVal" class="font-semibold text-gray-800">--%</span>
                                        </div>
                                        <div class="metric-track"><div id="atsExperienceBar" class="metric-fill"></div></div>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold text-gray-700 mb-4">Key Improvement Areas</h3>
                                <div id="quickSuggestionsOverview" class="space-y-3">
                                    <div class="h-12 bg-gray-100 rounded-lg animate-pulse"></div>
                                    <div class="h-12 bg-gray-100 rounded-lg animate-pulse"></div>
                                    <div class="h-12 bg-gray-100 rounded-lg animate-pulse"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Tab -->
                    <div id="overviewSkills" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Skills</h3>
                        <div id="skillsContainer" class="flex flex-wrap gap-2">
                            {% if resume_data and resume_data.parsed_data and resume_data.parsed_data.skills %}
                                {% for skill in resume_data.parsed_data.skills %}
                                    <span class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm font-medium">{{ skill }}</span>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-500">No skills found in your resume.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Experience Tab -->
                    <div id="overviewExperience" class="hidden">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Work Experience</h3>
                        <div id="experienceContainer" class="space-y-6">
                            {% if resume_data and resume_data.parsed_data and resume_data.parsed_data.experience %}
                                {% for exp in resume_data.parsed_data.experience %}
                                    <div class="relative pl-6">
                                        <div class="absolute left-0 h-full w-0.5 bg-gray-200"></div>
                                        <div class="absolute left-[-5px] top-1 w-3 h-3 bg-emerald-500 rounded-full border-2 border-white"></div>
                                        <div class="font-semibold text-gray-800">{{ exp.title | safe }}</div>
                                        <div class="text-gray-600 text-sm mb-1">{{ exp.company | safe }} <span class="text-gray-400 mx-1">â€¢</span> {{ exp.duration | safe }}</div>
                                        {% if exp.responsibilities %}
                                            <ul class="list-disc list-inside mt-2 space-y-1 text-sm text-gray-700">
                                                {% for resp in exp.responsibilities %}
                                                    <li>{{ resp | safe }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            {% else %}
                                <p class="text-gray-500">No work experience found in your resume.</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Right Panel: Resume Analytics + Quick Actions -->
                <div class="flex flex-col gap-6">
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Resume Analytics</h3>
                        <div class="space-y-4">
                            <div>
                                <div class="flex justify-between items-center mb-1 text-sm">
                                    <span class="font-medium text-gray-600">ATS Score</span>
                                    <span id="atsScoreValue" class="font-semibold text-gray-800">--%</span>
                                </div>
                                <div class="metric-track">
                                    <div id="atsScoreBar" class="metric-fill" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-600 text-sm mb-2">Best Job Matches</h4>
                                <div id="jobRoleFit" class="space-y-2">
                                    <div class="h-8 bg-gray-100 rounded-lg animate-pulse"></div>
                                    <div class="h-8 bg-gray-100 rounded-lg animate-pulse"></div>
                                    <div class="h-8 bg-gray-100 rounded-lg animate-pulse"></div>
                                </div>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-600 text-sm mb-2">Salary Estimate</h4>
                                <div id="salaryRange" class="p-3 bg-gray-50 rounded-lg">
                                    <div class="h-5 bg-gray-200 rounded w-3/4 mb-2 animate-pulse"></div>
                                    <div class="h-4 bg-gray-200 rounded w-1/2 animate-pulse"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Quick Actions</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <a href="/upload" class="quick-action-btn flex flex-col items-center justify-center text-center p-4 h-24">
                                <i class="fas fa-upload text-xl mb-1"></i>
                                <span class="text-sm">Upload New</span>
                            </a>
                            <a href="/analyze-job/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="quick-action-btn flex flex-col items-center justify-center text-center p-4 h-24">
                                <i class="fas fa-search text-xl mb-1"></i>
                                <span class="text-sm">Analyze Job</span>
                            </a>
                            <a href="/cover-letter/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="quick-action-btn flex flex-col items-center justify-center text-center p-4 h-24">
                                <i class="fas fa-envelope text-xl mb-1"></i>
                                <span class="text-sm">Cover Letter</span>
                            </a>
                            <a href="/email/{{ resume_data._id if resume_data and resume_data._id else resume_id }}" class="quick-action-btn flex flex-col items-center justify-center text-center p-4 h-24">
                                <i class="fas fa-paper-plane text-xl mb-1"></i>
                                <span class="text-sm">Cold Email</span>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
</div>


<script>
    // ---------- Analytics and Mapping (based on prev_dash) ----------
    function updateATSScore(score) {
        document.getElementById('atsScoreValue').textContent = score + '%';
        const bar = document.getElementById('atsScoreBar');
        bar.style.width = score + '%';
        if (score >= 80) { bar.style.background = '#059669'; }
        else if (score >= 60) { bar.style.background = '#f59e0b'; }
        else { bar.style.background = '#ef4444'; }
    }
    function renderAtsBreakdown(breakdown) {
        const items = [
            ['format','atsFormatBar','atsFormatVal'],
            ['keywords','atsKeywordsBar','atsKeywordsVal'],
            ['skills','atsSkillsBar','atsSkillsVal'],
            ['experience','atsExperienceBar','atsExperienceVal']
        ];
        items.forEach(([key, barId, valId]) => {
            const val = Math.round(Number(breakdown?.[key] || 0));
            const bar = document.getElementById(barId);
            const label = document.getElementById(valId);
            if (bar) bar.style.width = val + '%';
            if (label) label.textContent = val + '%';
        });
    }
    function renderRecommendations(analyticsData) {
        const list = document.getElementById('analyticsRecs');
        const gen = document.getElementById('generatedAt');
        const a = analyticsData || {};
        const recs = [];
        if (Array.isArray(a.ats_score?.recommendations)) recs.push(...a.ats_score.recommendations);
        if (Array.isArray(a.experience_analysis?.recommendations)) recs.push(...a.experience_analysis.recommendations);
        const html = recs.slice(0, 6).map(r => `<li>${r}</li>`).join('');
        if (list) list.innerHTML = html || '<li>No recommendations available</li>';
        if (gen && a.generated_at) gen.textContent = `Generated at ${a.generated_at}`;
    }
    function showDefaultAnalytics() {
        updateATSScore(75);
        renderAtsBreakdown({ format: 88, keywords: 78, skills: 85, experience: 83 });
        loadJobMatchesFromBackend([]);
        loadSalaryFromBackend({});
        loadSuggestionsFromBackend([]);
        renderRecommendations({});
    }
    async function loadAnalytics() {
        const analyticsDataString = '{{ analytics | tojson | safe }}';
        let analyticsData = {};
        try { analyticsData = JSON.parse(analyticsDataString); } catch (e) { showDefaultAnalytics(); return; }
        if (analyticsData && Object.keys(analyticsData).length > 0) {
            const atsScore = analyticsData.ats_score?.overall || 75;
            updateATSScore(atsScore);
            renderAtsBreakdown(analyticsData.ats_score?.breakdown || {});
            loadJobMatchesFromBackend(analyticsData.job_matches || []);
            loadSalaryFromBackend(analyticsData.salary_analysis || {});
            loadSuggestionsFromBackend(analyticsData.improvement_suggestions || []);
            renderRecommendations(analyticsData);
        } else { showDefaultAnalytics(); }
    }
    function loadJobMatchesFromBackend(jobMatches) {
        if (!jobMatches || jobMatches.length === 0) {
            jobMatches = [
                { role: 'Software Engineer', match_percentage: 85 },
                { role: 'Full Stack Developer', match_percentage: 80 },
                { role: 'Backend Developer', match_percentage: 75 }
            ];
        }
        const colors = ['job1','job2','job3'];
        const html = jobMatches.slice(0, 3).map((job, i) => `
            <div class="job-match-row ${colors[i]}">
                <span>${job.role}</span>
                <span>${job.match_percentage}% match</span>
            </div>`).join('');
        document.getElementById('jobRoleFit').innerHTML = html;
    }
    function loadSalaryFromBackend(salaryAnalysis) {
        const salaryRange = salaryAnalysis.estimated_range || '$75,000-$95,000';
        const location = salaryAnalysis.location_factor || 'United States';
        const growth = salaryAnalysis.growth_potential || '15% annually';
        document.getElementById('salaryRange').innerHTML = `
            <div class="text-xl font-bold mb-1">${salaryRange}</div>
            <div class="text-xs text-gray-500 mb-1">Based on your skills and experience</div>
            <div class="text-xs text-gray-500">Location: ${location}</div>
            <div class="text-xs text-gray-500">Growth: ${growth}</div>`;
    }
    function loadSuggestionsFromBackend(suggestions) {
        if (!suggestions || suggestions.length === 0) {
            suggestions = [
                { priority: 'High', suggestion: 'Add more quantified achievements' },
                { priority: 'Medium', suggestion: 'Include relevant certifications' },
                { priority: 'Low', suggestion: 'Update skills with trending technologies' }
            ];
        }
        const map = { High: ['tip-high', 'fa-exclamation-triangle'], Medium: ['tip-medium', 'fa-lightbulb'], Low: ['tip-low', 'fa-check'] };
        const html = suggestions.slice(0, 4).map(s => {
            const cls = map[s.priority]?.[0] || 'tip-low';
            const icon = map[s.priority]?.[1] || 'fa-check';
            return `<div class="improvement-tip ${cls}"><i class="fas ${icon} mr-2"></i>${s.suggestion}</div>`;
        }).join('');
        const target = document.getElementById('quickSuggestionsOverview');
        if (target) target.innerHTML = html;
    }

    // ---------- Populate Overview Tabs from resume_data ----------
    function populateFromResume() {
        let data = {};
        try { data = JSON.parse('{{ resume_data | tojson | safe }}') || {}; } catch (e) { data = {}; }
        const personal = (data.parsed_data && data.parsed_data.personal_info) || {};
        
        // Skills (fallback: server-side markup already present)
        const skills = (data.parsed_data && data.parsed_data.skills) || [];
        if (skills.length) {
            const skillsHtml = skills.slice(0, 50).map(skill => `<span class=\"bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-medium\">${skill}</span>`).join('');
            const skillsContainer = document.getElementById('skillsContainer');
            if (skillsContainer) skillsContainer.innerHTML = skillsHtml;
        }
        
        // Experience (fallback server-side present)
        const experience = (data.parsed_data && data.parsed_data.experience) || [];
        if (experience.length) {
            const expHtml = experience.map(exp => `
                <div class=\"border-l-4 border-emerald-500 pl-4 py-2\">
                    <div class=\"flex justify-between items-start mb-1\">
                        <div>
                            <div class=\"font-semibold text-gray-900\">${exp.title || ''}</div>
                            <div class=\"text-gray-600 text-sm\">${exp.company || ''}</div>
                        </div>
                        <span class=\"text-xs text-gray-500 whitespace-nowrap\">${exp.duration || ''}</span>
                    </div>
                    ${Array.isArray(exp.responsibilities) ? `<ul class='list-disc list-inside mt-1 space-y-1'>${exp.responsibilities.map(r => `<li class='text-gray-700'>${r}</li>`).join('')}</ul>` : ''}
                    ${Array.isArray(exp.achievements) ? `<div class='mt-2 text-sm'><span class='font-medium'>Key Achievements:</span><ul class='list-disc list-inside mt-1 space-y-1'>${exp.achievements.map(a => `<li class='text-gray-700'>${a}</li>`).join('')}</ul></div>` : ''}
                    ${Array.isArray(exp.technologies) ? `<div class='mt-2 flex flex-wrap gap-2'>${exp.technologies.map(t => `<span class='bg-gray-100 text-gray-700 px-2 py-1 rounded text-xs'>${t}</span>`).join('')}</div>` : ''}
                </div>`).join('');
            const expContainer = document.getElementById('experienceContainer');
            if (expContainer) expContainer.innerHTML = expHtml;
        }
        
        // Update profile information with better fallbacks
        const profileElements = {
            profileName: personal.name || 'User Name',
            profileEmail: personal.email || 'user@example.com'
        };
        
        // Update profile elements that still use JavaScript
        Object.entries(profileElements).forEach(([elementId, value]) => {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = value;
            }
        });
        
        // Update profile avatars with consistent image source
        const avatarSeed = encodeURIComponent(personal.email || personal.name || 'default-user');
        const avatarUrl = `https://api.dicebear.com/8.x/personas/svg?seed=${avatarSeed}&backgroundColor=b6e3f4,c0aede,d1d4f9&radius=50`;
        
        // Update all avatar images
        const avatarElements = ['profileAvatar', 'headerAvatar', 'sidebarAvatar'];
        avatarElements.forEach(avatarId => {
            const avatar = document.getElementById(avatarId);
            if (avatar) {
                avatar.src = avatarUrl;
                avatar.onerror = function() {
                    // Fallback to a different avatar service if DiceBear fails
                    this.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(personal.name || 'User')}&background=059669&color=fff&size=128&rounded=true`;
                };
            }
        });
        
        // Add hover effects and animations
        const profileBtn = document.getElementById('profileAvatarBtn');
        if (profileBtn) {
            profileBtn.addEventListener('mouseenter', function() {
                this.style.transform = 'scale(1.05)';
                this.style.transition = 'transform 0.2s ease';
            });
            profileBtn.addEventListener('mouseleave', function() {
                this.style.transform = 'scale(1)';
            });
        }
    }

    // ---------- Tabs and Profile Menu ----------
    function initTabs() {
        const buttons = Array.from(document.querySelectorAll('.tab-btn'));
        const panels = {
            summary: document.getElementById('overviewSummary'),
            skills: document.getElementById('overviewSkills'),
            experience: document.getElementById('overviewExperience')
        };
        buttons.forEach(btn => btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            const tab = btn.getAttribute('data-tab');
            Object.keys(panels).forEach(key => {
                if (panels[key]) panels[key].classList.toggle('hidden', key !== tab);
            });
        }));
    }
    function initProfileMenu() {
        const btn = document.getElementById('profileAvatarBtn');
        const menu = document.getElementById('profileMenu');
        if (!btn || !menu) return;
        
        btn.addEventListener('click', (e) => { 
            e.stopPropagation(); 
            if (menu.classList.contains('hidden')) {
                menu.classList.remove('hidden');
                menu.classList.add('profile-menu-enter');
            } else {
                menu.classList.add('hidden');
                menu.classList.remove('profile-menu-enter');
            }
        });
        
        document.addEventListener('click', (e) => { 
            if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
                menu.classList.remove('profile-menu-enter');
            }
        });
        
        // Add keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !menu.classList.contains('hidden')) {
                menu.classList.add('hidden');
                menu.classList.remove('profile-menu-enter');
            }
        });
    }

    // Handle user logout
    function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
            authManager.logout();
        }
    }

    // Authentication check on page load
    function checkAuthentication() {
        if (!authManager.isAuthenticated()) {
            authManager.redirectToLogin();
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Check authentication first
        if (!checkAuthentication()) {
            return;
        }
        
        loadAnalytics();
        populateFromResume();
        initTabs();
        initProfileMenu();
        initRoastWidget();
    });

    // ---------- Company Roast Widget Functionality ----------
    function initRoastWidget() {
        const floatingBtn = document.getElementById('floatingRoastBtn');
        const widget = document.getElementById('companyRoastWidget');
        const closeBtn = document.getElementById('closeRoastWidget');
        const roastBtn = document.getElementById('roastButton');
        const companyBtns = document.querySelectorAll('.company-roast-btn');
        const urlInput = document.getElementById('linkedinUrlInput');
        
        let selectedCompany = null;
        
        // Show/hide widget
        floatingBtn.addEventListener('click', () => {
            widget.classList.add('show');
            floatingBtn.classList.add('hidden');
        });
        
        closeBtn.addEventListener('click', () => {
            widget.classList.remove('show');
            floatingBtn.classList.remove('hidden');
            resetRoastWidget();
        });
        
        // Company selection
        companyBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                companyBtns.forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedCompany = btn.dataset.company;
                updateRoastButton();
            });
        });
        
        // URL input validation
        urlInput.addEventListener('input', updateRoastButton);
        
        function updateRoastButton() {
            const hasUrl = urlInput.value.trim() !== '';
            const hasCompany = selectedCompany !== null;
            roastBtn.disabled = !(hasUrl && hasCompany);
            
            if (hasUrl && hasCompany) {
                roastBtn.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-400/20 via-orange-400/20 to-red-400/20 animate-pulse opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10 flex items-center justify-center">
                        <i class="fas fa-fire mr-2 text-yellow-200 drop-shadow-lg animate-bounce"></i>
                        <span class="text-lg font-extrabold tracking-wide drop-shadow-lg bg-gradient-to-r from-yellow-200 via-orange-200 to-red-200 bg-clip-text text-transparent animate-pulse">Get Roasted by ${selectedCompany.charAt(0).toUpperCase() + selectedCompany.slice(1)}!</span>
                    </div>`;
            } else {
                roastBtn.innerHTML = `
                    <div class="absolute inset-0 bg-gradient-to-r from-yellow-400/20 via-orange-400/20 to-red-400/20 animate-pulse opacity-0 hover:opacity-100 transition-opacity duration-300"></div>
                    <div class="relative z-10 flex items-center justify-center">
                        <i class="fas fa-fire mr-2 text-yellow-200 drop-shadow-lg animate-bounce"></i>
                        <span class="text-lg font-extrabold tracking-wide drop-shadow-lg bg-gradient-to-r from-yellow-200 via-orange-200 to-red-200 bg-clip-text text-transparent animate-pulse">Get Roasted!</span>
                    </div>`;
            }
        }
        
        // Roast functionality
        roastBtn.addEventListener('click', async () => {
            if (roastBtn.disabled) return;
            
            const url = urlInput.value.trim();
            if (!url || !selectedCompany) return;
            
            // Show loading state
            showRoastLoading();
            
            try {
                const response = await fetch('/api/roast-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        profile_url: url,
                        user_interests: [],
                        tone: 'witty',
                        company: selectedCompany
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showRoastResults(data);
                } else {
                    showRoastError(data.error || 'Failed to roast profile');
                }
            } catch (error) {
                console.error('Roast error:', error);
                showRoastError('Network error. Please try again.');
            }
        });
        
        // View roast button click
        document.getElementById('viewRoastBtn').addEventListener('click', () => {
            showRoastModal();
        });
        
        // Modal functionality with cool animations
        document.getElementById('closeRoastModal').addEventListener('click', () => {
            closeModalWithAnimation();
        });
        
        // Close modal when clicking outside
        document.getElementById('roastModal').addEventListener('click', (e) => {
            if (e.target.id === 'roastModal') {
                closeModalWithAnimation();
            }
        });
        
        // ESC key to close modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && !document.getElementById('roastModal').classList.contains('hidden')) {
                closeModalWithAnimation();
            }
        });
        
        function closeModalWithAnimation() {
            const modal = document.getElementById('roastModal');
            const modalContent = document.getElementById('modalContent');
            
            modal.classList.add('backdrop-exit');
            modalContent.classList.add('modal-exit');
            
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('backdrop-exit', 'backdrop-enter');
                modalContent.classList.remove('modal-exit', 'modal-enter');
            }, 300);
        }
        
        // LinkedIn share functionality - FIXED
        document.getElementById('shareLinkedIn').addEventListener('click', () => {
            const companyName = selectedCompany ? selectedCompany.charAt(0).toUpperCase() + selectedCompany.slice(1) : 'Tech Giants';
            const roastQuote = document.getElementById('modalRoastQuote').textContent;
            
            const linkedInText = `ðŸ”¥ Just got roasted by ${companyName} standards!

"${roastQuote}"

Sometimes the truth hurts, but it's what we need to grow! ðŸ’ª

Ready to level up your LinkedIn game? Get your profile roasted too!

#LinkedInRoast #ProfessionalGrowth #CareerDevelopment #TechCareers #ProfileOptimization

Powered by SYNTEXA.app ðŸš€`;
            
            // Use the correct LinkedIn sharing URL format
            const encodedText = encodeURIComponent(linkedInText);
            const encodedUrl = encodeURIComponent('https://syntexa.app');
            const linkedInUrl = `https://www.linkedin.com/feed/?shareActive=true&text=${encodedText}`;
            
            window.open(linkedInUrl, '_blank', 'width=600,height=600,scrollbars=yes,resizable=yes');
        });
        
        // Twitter share functionality
        document.getElementById('shareTwitter').addEventListener('click', () => {
            const companyName = selectedCompany ? selectedCompany.charAt(0).toUpperCase() + selectedCompany.slice(1) : 'Tech Giants';
            const roastQuote = document.getElementById('modalRoastQuote').textContent;
            const twitterText = `ðŸ”¥ Just got roasted by ${companyName}! "${roastQuote}" 

Ready for your roast? 

#LinkedInRoast #SYNTEXA

syntexa.app`;
            
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(twitterText)}`;
            window.open(twitterUrl, '_blank');
        });
        
        // New roast functionality
        document.getElementById('newRoastModal').addEventListener('click', () => {
            closeModalWithAnimation();
            setTimeout(() => {
                resetRoastWidget();
            }, 300);
        });
        
        function showRoastLoading() {
            document.getElementById('roastLoading').classList.remove('hidden');
            document.getElementById('roastResults').classList.add('hidden');
            document.getElementById('roastError').classList.add('hidden');
            roastBtn.disabled = true;
        }
        
        function showRoastResults(data) {
            document.getElementById('roastLoading').classList.add('hidden');
            document.getElementById('roastError').classList.add('hidden');
            
            const results = document.getElementById('roastResults');
            const roast = data.roast;
            
            // Store roast data globally for modal
            window.currentRoast = roast;
            window.currentCompany = selectedCompany;
            
            // Set roast level
            const levelElement = document.getElementById('roastLevel');
            levelElement.textContent = roast.roast_level || 'medium';
            levelElement.className = `text-xs px-2 py-1 rounded-full text-white ${getLevelClass(roast.roast_level)}`;
            
            results.classList.remove('hidden');
            roastBtn.disabled = false;
        }
        
        function showRoastModal() {
            const roast = window.currentRoast;
            const company = window.currentCompany;
            
            if (!roast) return;
            
            // Populate modal content
            document.getElementById('modalCompanyName').textContent = company ? company.charAt(0).toUpperCase() + company.slice(1) : 'Tech Giants';
            document.getElementById('modalRoastLevel').textContent = roast.roast_level || 'Medium';
            document.getElementById('modalRoastLevel').className = `inline-block px-4 py-2 rounded-full text-white font-bold text-lg ${getLevelClass(roast.roast_level)}`;
            document.getElementById('modalRoastSummary').textContent = roast.complete_roast_summary || 'No roast available';
            document.getElementById('modalRoastQuote').textContent = roast.comedy_gold_quote || 'No quote available';
            
            // Show modal with cool animation
            const modal = document.getElementById('roastModal');
            const modalContent = document.getElementById('modalContent');
            
            modal.classList.remove('hidden');
            modal.classList.add('backdrop-enter');
            modalContent.classList.add('modal-enter');
            
            // Remove animation classes after animation completes
            setTimeout(() => {
                modal.classList.remove('backdrop-enter');
                modalContent.classList.remove('modal-enter');
            }, 400);
        }
        
        function showRoastError(message) {
            document.getElementById('roastLoading').classList.add('hidden');
            document.getElementById('roastResults').classList.add('hidden');
            
            const errorDiv = document.getElementById('roastError');
            document.getElementById('errorMessage').textContent = message;
            errorDiv.classList.remove('hidden');
            
            roastBtn.disabled = false;
        }
        
        function resetRoastWidget() {
            selectedCompany = null;
            urlInput.value = '';
            companyBtns.forEach(btn => btn.classList.remove('selected'));
            document.getElementById('roastResults').classList.add('hidden');
            document.getElementById('roastLoading').classList.add('hidden');
            document.getElementById('roastError').classList.add('hidden');
            window.currentRoast = null;
            window.currentCompany = null;
            updateRoastButton();
        }
        
        function getLevelClass(level) {
            const classes = {
                'mild': 'bg-emerald-500',
                'medium': 'bg-yellow-500',
                'spicy': 'bg-orange-500',
                'savage': 'bg-red-500',
                'nuclear': 'bg-purple-500'
            };
            return classes[level] || 'bg-emerald-500';
        }
    }
</script>
</body>
</html>