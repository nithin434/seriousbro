<!DOCTYPE html>
<html>
<head>
    <title>Customize Cover Letter</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Customization Form -->
            <div class="bg-white rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Customize Cover Letter</h2>
                <form id="coverLetterForm" class="space-y-4">
                    <input type="hidden" id="resumeId" value="{{ resume_id }}">

                    <div>
                        <label class="block text-gray-700 mb-2">Company Name</label>
                        <input type="text" id="companyName" class="w-full p-2 border rounded" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2">Position</label>
                        <input type="text" id="position" class="w-full p-2 border rounded" required>
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2">Job Description</label>
                        <textarea id="jobDescription" class="w-full p-2 border rounded h-32" required></textarea>
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2">Additional Context (Optional)</label>
                        <textarea id="additionalContext" class="w-full p-2 border rounded h-24"></textarea>
                    </div>

                    <button type="submit" class="w-full bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600">
                        Generate Cover Letter
                    </button>
                </form>
            </div>

            <!-- Generated Cover Letter -->
            <div id="generatedLetter" class="bg-white rounded-lg shadow p-6" style="display: none;">
                <h2 class="text-xl font-bold mb-4">Generated Cover Letter</h2>
                <div id="letterContent" class="prose max-w-none"></div>
                
                <!-- Regeneration Form -->
                <div id="regenerateForm" class="mt-6 border-t pt-4">
                    <h3 class="font-medium mb-2">Want to regenerate?</h3>
                    <textarea id="feedback" 
                            class="w-full p-2 border rounded h-24 mb-2" 
                            placeholder="Please provide feedback for improvements..."></textarea>
                    <button onclick="regenerateLetter()" 
                            class="w-full bg-purple-500 text-white py-2 px-4 rounded hover:bg-purple-600">
                        Regenerate with Feedback
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.getElementById('coverLetterForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            await generateLetter();
        });

        async function generateLetter(regenerate = false) {
            const submitButton = document.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            
            try {
                const endpoint = regenerate ? '/api/cover-letter/regenerate' : '/api/cover-letter/generate';
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resume_id: document.getElementById('resumeId').value,
                        company_name: document.getElementById('companyName').value,
                        position: document.getElementById('position').value,
                        job_description: document.getElementById('jobDescription').value,
                        additional_context: document.getElementById('additionalContext').value,
                        feedback: regenerate ? document.getElementById('feedback').value : ''
                    })
                });

                const result = await response.json();
                if (result.success) {
                    document.getElementById('letterContent').innerHTML = result.cover_letter
                        .replace(/\n/g, '<br>')
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    document.getElementById('generatedLetter').style.display = 'block';
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to generate cover letter');
            } finally {
                submitButton.disabled = false;
            }
        }

        async function regenerateLetter() {
            const feedback = document.getElementById('feedback').value;
            if (!feedback) {
                alert('Please provide feedback for regeneration');
                return;
            }
            await generateLetter(true);
        }
    </script>
</body>
</html>