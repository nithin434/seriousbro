<!DOCTYPE html>
<html>
<head>
    <title>Job Analysis â€¢ Syntexa</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Montserrat', sans-serif; }
        .emerald { color: #059669; }
        .emerald-bg { background: #059669; }
        .brand-syn { color: #059669; }
        .brand-texa { color: #111827; }
        .card { background: #fff; border-radius: 1.25rem; box-shadow: 0 4px 24px 0 rgba(31, 38, 135, 0.08); transition: box-shadow 0.3s; }
        .card:hover { box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.12); }
        .header-btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: all 0.2s; text-decoration: none; }
        .header-btn.improve { background: #f0fdf4; color: #059669; border: 1px solid #059669; }
        .header-btn.improve:hover { background: #059669; color: #fff; }
        
        /* Cool loading animations */
        .loading-container {
            position: relative;
            overflow: hidden;
        }
        .loading-particles {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
        }
        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #059669;
            border-radius: 50%;
            animation: float 3s ease-in-out infinite;
        }
        .particle:nth-child(1) { left: 20%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 40%; animation-delay: 0.5s; }
        .particle:nth-child(3) { left: 60%; animation-delay: 1s; }
        .particle:nth-child(4) { left: 80%; animation-delay: 1.5s; }
        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); opacity: 1; }
            50% { transform: translateY(-20px) scale(1.2); opacity: 0.7; }
        }
        
        .typing-animation {
            overflow: hidden;
            border-right: 2px solid #059669;
            white-space: nowrap;
            animation: typing 3s steps(40, end), blink-caret 0.75s step-end infinite;
        }
        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
        @keyframes blink-caret {
            from, to { border-color: transparent; }
            50% { border-color: #059669; }
        }
        
        .success-animation {
            animation: successPop 0.5s ease-out;
        }
        @keyframes successPop {
            0% { transform: scale(0.8); opacity: 0; }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .action-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .action-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        .action-btn:hover::before {
            left: 100%;
        }
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.3);
        }
        
        .skill-match { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; }
        .skill-missing { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .skill-required { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        
        .match-score-high { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .match-score-medium { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .match-score-low { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-gray-200 px-6 py-4">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center">
                <a href="/" class="flex items-center">
                    <span class="text-2xl font-extrabold tracking-tight">
                        <span class="brand-syn">Syn</span><span class="brand-texa">texa</span>
                    </span>
                </a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/dashboard/{{resume_id}}" class="header-btn improve flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </header>

    <div class="max-w-7xl mx-auto px-6 py-8">
        <div class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 mb-4">
                <i class="fas fa-search text-emerald-600 mr-3"></i>Comprehensive Job Analysis
            </h1>
            <p class="text-xl text-gray-600">Analyze job requirements and optimize your resume for better matches</p>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Input Form -->
            <div class="card p-8">
                <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                    <div class="text-2xl font-bold">Job Analysis Form</div>
                    <div class="text-sm text-gray-200">Enter job details for comprehensive analysis</div>
                </div>
                
                <form id="jobAnalysisForm" class="space-y-6">
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Job Title</label>
                        <input type="text" id="jobTitle" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required
                               placeholder="e.g. Senior Software Engineer">
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Company Name</label>
                        <input type="text" id="companyName" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required
                               placeholder="e.g. Google, Microsoft">
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Industry</label>
                        <select id="industry" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" required>
                            <option value="">Select Industry</option>
                            <option value="technology">Technology</option>
                            <option value="finance">Finance</option>
                            <option value="healthcare">Healthcare</option>
                            <option value="retail">Retail</option>
                            <option value="manufacturing">Manufacturing</option>
                            <option value="education">Education</option>
                            <option value="consulting">Consulting</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Job Description</label>
                        <textarea id="jobDescription" 
                                class="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 h-64"
                                placeholder="Paste job description here..."
                                required></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-gray-700 mb-2 font-medium">Job URL (Optional)</label>
                        <input type="url" id="jobUrl" 
                               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               placeholder="Paste job posting URL">
                        <p class="text-sm text-gray-500 mt-1">
                            <i class="fas fa-info-circle mr-1"></i>Supports LinkedIn, Indeed, and other major job boards
                        </p>
                    </div>

                    <button type="submit" 
                            class="w-full bg-emerald-600 text-white py-3 px-6 rounded-lg hover:bg-emerald-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                        <i class="fas fa-search mr-2"></i>Analyze Job
                    </button>
                </form>
            </div>

            <!-- Analysis Results -->
            <div id="analysisResults" class="space-y-6 hidden">
                <!-- Loading State -->
                <div id="loadingState" class="card p-8">
                    <div class="text-center loading-container">
                        <div class="loading-particles">
                            <div class="particle"></div>
                            <div class="particle"></div>
                            <div class="particle"></div>
                            <div class="particle"></div>
                        </div>
                        <div class="relative z-10">
                            <div class="mb-6">
                                <i class="fas fa-chart-line text-6xl text-emerald-600 animate-bounce"></i>
                            </div>
                            <h3 class="text-xl font-semibold text-gray-900 mb-2 typing-animation">Analyzing job requirements...</h3>
                            <p class="text-gray-600">Our AI is gathering real-time data and analyzing the job requirements</p>
                            <div class="mt-6 flex justify-center">
                                <div class="flex space-x-2">
                                    <div class="w-3 h-3 bg-emerald-600 rounded-full animate-bounce"></div>
                                    <div class="w-3 h-3 bg-emerald-600 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                                    <div class="w-3 h-3 bg-emerald-600 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Content -->
                <div id="resultsContent" class="hidden space-y-6">
                    <!-- Match Score -->
                    <div class="card p-6">
                        <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                            <div class="text-2xl font-bold">Match Analysis</div>
                            <div class="text-sm text-gray-200">How well your resume matches this job</div>
                        </div>
                        <div class="flex items-center mb-4">
                            <div class="w-full bg-gray-200 rounded-full h-4 mr-4">
                                <div id="matchScoreBar" class="h-4 rounded-full transition-all duration-1000"></div>
                            </div>
                            <span id="matchScore" class="text-lg font-bold"></span>
                        </div>
                        <div id="matchDescription" class="text-gray-600"></div>
                    </div>

                    <!-- Required Skills -->
                    <div class="card p-6">
                        <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                            <div class="text-2xl font-bold">Required Skills</div>
                            <div class="text-sm text-gray-200">Skills needed for this position</div>
                        </div>
                        <div id="skillsAnalysis" class="space-y-4"></div>
                    </div>

                    <!-- Experience Requirements -->
                    <div class="card p-6">
                        <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                            <div class="text-2xl font-bold">Experience Requirements</div>
                            <div class="text-sm text-gray-200">Experience needed for this role</div>
                        </div>
                        <div id="experienceAnalysis"></div>
                    </div>

                    <!-- Recommendations -->
                    <div class="card p-6">
                        <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                            <div class="text-2xl font-bold">Recommendations</div>
                            <div class="text-sm text-gray-200">Action items to improve your application</div>
                        </div>
                        <div id="recommendations"></div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="card p-6">
                        <div class="bg-black text-white rounded-t-2xl px-6 py-4 mb-6">
                            <div class="text-2xl font-bold">Next Steps</div>
                            <div class="text-sm text-gray-200">Ready to apply? Create your application materials</div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <a href="/improve-resume/{{resume_id}}" 
                               class="bg-emerald-600 text-white py-3 px-4 rounded-lg hover:bg-emerald-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                                <i class="fas fa-magic mr-2"></i>Optimize Resume
                            </a>
                            <a href="/cover-letter/{{resume_id}}" 
                               class="bg-purple-600 text-white py-3 px-4 rounded-lg hover:bg-purple-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                                <i class="fas fa-envelope mr-2"></i>Write Cover Letter
                            </a>
                            <a href="/email/{{resume_id}}" 
                               class="bg-indigo-600 text-white py-3 px-4 rounded-lg hover:bg-indigo-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                                <i class="fas fa-paper-plane mr-2"></i>Send Cold Email
                            </a>
                            <a href="/generate-ats-resume/{{resume_id}}" 
                               class="bg-blue-600 text-white py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-200 font-semibold flex items-center justify-center action-btn">
                                <i class="fas fa-file-pdf mr-2"></i>Generate ATS Resume
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scraping Status -->
    <div class="fixed bottom-4 right-4 bg-white rounded-lg shadow-lg p-4 transition-opacity duration-300 border border-emerald-200" 
         id="scrapingStatus">
        <div class="flex items-center space-x-3">
            <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-emerald-500"></div>
            <span class="text-sm text-gray-600">Gathering real-time data...</span>
        </div>
    </div>

    <script>
        const form = document.getElementById('jobAnalysisForm');
        const loadingState = document.getElementById('loadingState');
        const resultsContent = document.getElementById('resultsContent');
        const analysisResults = document.getElementById('analysisResults');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading();
            updateScrapingStatus(true);

            try {
                const response = await fetch('/api/resume/analyze-job', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        job_url: document.getElementById('jobUrl').value,
                        job_title: document.getElementById('jobTitle').value,
                        company_name: document.getElementById('companyName').value,
                        industry: document.getElementById('industry').value,
                        job_description: document.getElementById('jobDescription').value,
                        resume_id: '{{ resume_id }}'
                    })
                });

                const result = await response.json();
                if (result.success) {
                    displayResults(result);
                } else {
                    alert(result.error || 'Failed to analyze job');
                }
                updateScrapingStatus(false);
            } catch (error) {
                updateScrapingStatus(false);
                console.error('Error:', error);
                alert('Failed to analyze job description');
            }
        });

        // Add autofill function when URL is provided
        document.getElementById('jobUrl').addEventListener('change', async (e) => {
            const url = e.target.value;
            if (url) {
                try {
                    const response = await fetch('/api/resume/extract-job', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ url })
                    });
                    
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById('jobTitle').value = result.title;
                        document.getElementById('companyName').value = result.company;
                        document.getElementById('jobDescription').value = result.description;
                        if (result.industry) {
                            document.getElementById('industry').value = result.industry;
                        }
                    }
                } catch (error) {
                    console.error('Error extracting job details:', error);
                }
            }
        });

        function showLoading() {
            analysisResults.classList.remove('hidden');
            loadingState.classList.remove('hidden');
            resultsContent.classList.add('hidden');
        }

        function updateScrapingStatus(isVisible) {
            const status = document.getElementById('scrapingStatus');
            status.style.opacity = isVisible ? '1' : '0';
            setTimeout(() => {
                status.style.display = isVisible ? 'block' : 'none';
            }, isVisible ? 0 : 300);
        }

        function displayResults(result) {
            loadingState.classList.add('hidden');
            resultsContent.classList.remove('hidden');

            // Display match score
            const matchScore = result.analysis.match_analysis?.overall_match || 75;
            const matchScoreBar = document.getElementById('matchScoreBar');
            const matchScoreText = document.getElementById('matchScore');
            const matchDescription = document.getElementById('matchDescription');
            
            matchScoreBar.style.width = `${matchScore}%`;
            matchScoreText.textContent = `${matchScore}% Match`;
            
            // Set color based on score
            if (matchScore >= 80) {
                matchScoreBar.className = 'h-4 rounded-full transition-all duration-1000 match-score-high';
                matchDescription.textContent = 'Excellent match! Your skills align well with this position.';
            } else if (matchScore >= 60) {
                matchScoreBar.className = 'h-4 rounded-full transition-all duration-1000 match-score-medium';
                matchDescription.textContent = 'Good match with room for improvement. Consider optimizing your resume.';
            } else {
                matchScoreBar.className = 'h-4 rounded-full transition-all duration-1000 match-score-low';
                matchDescription.textContent = 'Limited match. Focus on developing missing skills or targeting different roles.';
            }

            // Display skills analysis
            if (result.analysis.details?.required_skills) {
                displaySkillsAnalysis({
                    required_skills: result.analysis.details.required_skills,
                    matching_skills: result.analysis.match_analysis?.matching_skills || [],
                    missing_skills: result.analysis.match_analysis?.missing_skills || []
                });
            }

            // Display experience analysis
            if (result.analysis.details?.experience_needed) {
                displayExperienceAnalysis({
                    experience: result.analysis.details.experience_needed,
                    requirements: result.analysis.details.requirements || []
                });
            }

            // Display recommendations
            displayRecommendations(result.analysis);
        }

        function displaySkillsAnalysis(analysis) {
            const skillsDiv = document.getElementById('skillsAnalysis');
            
            let skillsHtml = `
                <div class="space-y-6">
                    <!-- Required Skills -->
                    <div>
                        <h3 class="font-semibold text-lg text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-star text-emerald-600 mr-2"></i>Required Skills
                        </h3>
                        <div class="space-y-3">
                            ${Object.entries(analysis.required_skills || {}).map(([category, skills]) => `
                                <div class="bg-gray-50 p-4 rounded-lg">
                                    <h4 class="font-medium text-gray-700 mb-2">${category.charAt(0).toUpperCase() + category.slice(1)}</h4>
                                    <div class="flex flex-wrap gap-2">
                                        ${skills.map(skill => `
                                            <span class="skill-required px-3 py-1 rounded-full text-sm font-medium">${skill}</span>
                                        `).join('')}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Matching Skills -->
                    <div>
                        <h3 class="font-semibold text-lg text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>Your Matching Skills
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${(analysis.matching_skills || []).map(skill => `
                                <span class="skill-match px-3 py-1 rounded-full text-sm font-medium">${skill}</span>
                            `).join('')}
                            ${(analysis.matching_skills || []).length === 0 ? 
                                '<span class="text-gray-500">No matching skills found. Consider updating your resume.</span>' : ''}
                        </div>
                    </div>

                    <!-- Skills to Develop -->
                    <div>
                        <h3 class="font-semibold text-lg text-gray-900 mb-3 flex items-center">
                            <i class="fas fa-exclamation-triangle text-yellow-600 mr-2"></i>Skills to Develop
                        </h3>
                        <div class="flex flex-wrap gap-2">
                            ${(analysis.missing_skills || []).map(skill => `
                                <span class="skill-missing px-3 py-1 rounded-full text-sm font-medium">${skill}</span>
                            `).join('')}
                            ${(analysis.missing_skills || []).length === 0 ? 
                                '<span class="text-green-600 font-medium">Great! You have all the required skills.</span>' : ''}
                        </div>
                    </div>
                </div>
            `;
            
            skillsDiv.innerHTML = skillsHtml;
        }

        function displayExperienceAnalysis(analysis) {
            const experienceDiv = document.getElementById('experienceAnalysis');
            const experience = analysis.experience || {};
            const requirements = analysis.requirements || [];
            
            let experienceHtml = `
                <div class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-lg text-gray-900 mb-3">Experience Requirements</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-700">
                                    <span class="font-medium">Years Required:</span> ${experience.years || 'Not specified'}
                                </p>
                            </div>
                            <div>
                                <p class="text-gray-700">
                                    <span class="font-medium">Level:</span> ${experience.level || 'Not specified'}
                                </p>
                            </div>
                        </div>
                        ${experience.domain && experience.domain.length ? `
                            <div class="mt-4">
                                <p class="font-medium text-gray-700 mb-2">Domain Experience:</p>
                                <div class="flex flex-wrap gap-2">
                                    ${experience.domain.map(domain => `
                                        <span class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm">${domain}</span>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>

                    ${requirements.length > 0 ? `
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-semibold text-lg text-gray-900 mb-3">Key Requirements</h3>
                            <ul class="space-y-2">
                                ${requirements.map(req => `
                                    <li class="flex items-start">
                                        <i class="fas fa-arrow-right text-emerald-600 mt-1 mr-3"></i>
                                        <span class="text-gray-700">${req}</span>
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
            
            experienceDiv.innerHTML = experienceHtml;
        }

        function displayRecommendations(analysis) {
            const recommendationsDiv = document.getElementById('recommendations');
            const recommendations = analysis.match_analysis?.recommendations || [];
            
            if (recommendations.length === 0) {
                recommendationsDiv.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-thumbs-up text-4xl text-emerald-600 mb-4"></i>
                        <p class="text-gray-600">Great job! Your profile matches well with this position.</p>
                    </div>
                `;
                return;
            }
            
            let recommendationsHtml = `
                <div class="space-y-4">
                    ${recommendations.map((rec, index) => `
                        <div class="flex items-start p-4 bg-blue-50 rounded-lg border border-blue-200">
                            <div class="bg-blue-600 text-white text-sm font-bold rounded-full w-6 h-6 flex items-center justify-center mr-4 mt-0.5">${index + 1}</div>
                            <div class="flex-1">
                                <p class="text-gray-700 font-medium">${rec}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            recommendationsDiv.innerHTML = recommendationsHtml;
        }
    </script>
</body>
</html>